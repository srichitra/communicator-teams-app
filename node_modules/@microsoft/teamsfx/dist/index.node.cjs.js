"use strict";var e=require("jwt-decode"),t=require("@azure/msal-node"),o=require("crypto"),n=require("botbuilder"),i=require("botbuilder-dialogs"),r=require("uuid"),s=require("axios"),a=require("https"),d=require("adaptivecards-templating"),c=require("path"),l=require("fs");function u(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(o){if("default"!==o){var n=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,n.get?n:{enumerable:!0,get:function(){return e[o]}})}})),t.default=e,Object.freeze(t)}var h,p,v=u(d),y=u(c),f=u(l);exports.ErrorCode=void 0,(h=exports.ErrorCode||(exports.ErrorCode={})).InvalidParameter="InvalidParameter",h.InvalidConfiguration="InvalidConfiguration",h.InvalidCertificate="InvalidCertificate",h.InternalError="InternalError",h.ChannelNotSupported="ChannelNotSupported",h.FailedToRetrieveSsoToken="FailedToRetrieveSsoToken",h.FailedToProcessSsoHandler="FailedToProcessSsoHandler",h.CannotFindCommand="CannotFindCommand",h.FailedToRunSsoStep="FailedToRunSsoStep",h.FailedToRunDedupStep="FailedToRunDedupStep",h.SsoActivityHandlerIsUndefined="SsoActivityHandlerIsUndefined",h.RuntimeNotSupported="RuntimeNotSupported",h.ConsentFailed="ConsentFailed",h.UiRequiredError="UiRequiredError",h.TokenExpiredError="TokenExpiredError",h.ServiceError="ServiceError",h.FailedOperation="FailedOperation",h.InvalidResponse="InvalidResponse",h.AuthorizationInfoAlreadyExists="AuthorizationInfoAlreadyExists";class m{}m.InvalidConfiguration="{0} in configuration is invalid: {1}.",m.ConfigurationNotExists="Configuration does not exist. {0}",m.ResourceConfigurationNotExists="{0} resource configuration does not exist.",m.MissingResourceConfiguration="Missing resource configuration with type: {0}, name: {1}.",m.AuthenticationConfigurationNotExists="Authentication configuration does not exist.",m.BrowserRuntimeNotSupported="{0} is not supported in browser.",m.NodejsRuntimeNotSupported="{0} is not supported in Node.",m.FailToAcquireTokenOnBehalfOfUser="Failed to acquire access token on behalf of user: {0}",m.OnlyMSTeamsChannelSupported="{0} is only supported in MS Teams Channel",m.FailedToProcessSsoHandler="Failed to process sso handler: {0}",m.FailedToRetrieveSsoToken="Failed to retrieve sso token, user failed to finish the AAD consent flow.",m.CannotFindCommand="Cannot find command: {0}",m.FailedToRunSsoStep="Failed to run dialog to retrieve sso token: {0}",m.FailedToRunDedupStep="Failed to run dialog to remove duplicated messages: {0}",m.SsoActivityHandlerIsNull="Sso command can only be used or added when sso activity handler is not undefined",m.AuthorizationHeaderAlreadyExists="Authorization header already exists!",m.BasicCredentialAlreadyExists="Basic credential already exists!",m.EmptyParameter="Parameter {0} is empty",m.DuplicateHttpsOptionProperty="Axios HTTPS agent already defined value for property {0}",m.DuplicateApiKeyInHeader="The request already defined api key in request header with name {0}.",m.DuplicateApiKeyInQueryParam="The request already defined api key in query parameter with name {0}.",m.OnlySupportInQueryActivity="The handleMessageExtensionQueryWithToken only support in handleTeamsMessagingExtensionQuery with composeExtension/query type.",m.OnlySupportInLinkQueryActivity="The handleMessageExtensionLinkQueryWithSSO only support in handleTeamsAppBasedLinkQuery with composeExtension/queryLink type.";class g extends Error{constructor(e,t){if(!t)return super(e),this;super(e),Object.setPrototypeOf(this,g.prototype),this.name=`${new.target.name}.${t}`,this.code=t}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function C(e,t,o,n){return new(o||(o=Promise))((function(i,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function a(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))}exports.LogLevel=void 0,(p=exports.LogLevel||(exports.LogLevel={}))[p.Verbose=0]="Verbose",p[p.Info=1]="Info",p[p.Warn=2]="Warn",p[p.Error=3]="Error";const x=new class{constructor(e,t){this.level=void 0,this.defaultLogger={verbose:console.debug,info:console.info,warn:console.warn,error:console.error},this.name=e,this.level=t}error(e){this.log(exports.LogLevel.Error,(e=>e.error),e)}warn(e){this.log(exports.LogLevel.Warn,(e=>e.warn),e)}info(e){this.log(exports.LogLevel.Info,(e=>e.info),e)}verbose(e){this.log(exports.LogLevel.Verbose,(e=>e.verbose),e)}log(e,t,o){if(""===o.trim())return;const n=(new Date).toUTCString();let i;i=this.name?`[${n}] : @microsoft/teamsfx - ${this.name} : ${exports.LogLevel[e]} - `:`[${n}] : @microsoft/teamsfx : ${exports.LogLevel[e]} - `;const r=`${i}${o}`;void 0!==this.level&&this.level<=e&&(this.customLogger?t(this.customLogger)(r):this.customLogFunction?this.customLogFunction(e,r):t(this.defaultLogger)(r))}};function A(t){try{const o=e.jwtDecode(t);if(!o||!o.exp)throw new g("Decoded token is null or exp claim does not exists.",exports.ErrorCode.InternalError);return o}catch(e){const t="Parse jwt token failed in node env with error: "+e.message;throw x.error(t),new g(t,exports.ErrorCode.InternalError)}}function T(e,...t){const o=t;return e.replace(/{(\d+)}/g,(function(e,t){return void 0!==o[t]?o[t]:e}))}function S(e){if("string"==typeof e||e instanceof String)return;if(Array.isArray(e)&&0===e.length)return;if(Array.isArray(e)&&e.length>0&&e.every((e=>"string"==typeof e)))return;const t="The type of scopes is not valid, it must be string or string array";throw x.error(t),new g(t,exports.ErrorCode.InvalidParameter)}function w(e){return("string"==typeof e?e.split(" "):e).filter((e=>null!==e&&""!==e))}function I(e){const n=(i=e.authorityHost,r=e.tenantId,i.replace(/\/+$/g,"")+"/"+r);var i,r;const s=function(e){if(!e)return;const t=/(-+BEGIN CERTIFICATE-+)(\n\r?|\r\n?)([A-Za-z0-9+/\n\r]+=*)(\n\r?|\r\n?)(-+END CERTIFICATE-+)/.exec(e);if(!t){const e="The certificate content does not contain a PEM-encoded certificate.";throw x.error(e),new g(e,exports.ErrorCode.InvalidCertificate)}return{thumbprintSha256:o.createHash("sha256").update(Buffer.from(t[3],"base64")).digest("hex").toUpperCase(),privateKey:e}}(e.certificateContent),a={clientId:e.clientId,authority:n};return s?a.clientCertificate=s:a.clientSecret=e.clientSecret,new t.ConfidentialClientApplication({auth:a})}class E{constructor(e,t){x.info("Get on behalf of user credential");const o=[];if(t.clientId||o.push("clientId"),t.authorityHost||o.push("authorityHost"),t.clientSecret||t.certificateContent||o.push("clientSecret or certificateContent"),t.tenantId||o.push("tenantId"),0!=o.length){const e=T(m.InvalidConfiguration,o.join(", "),"undefined");throw x.error(e),new g(e,exports.ErrorCode.InvalidConfiguration)}this.msalClient=I(t);const n=A(e);this.ssoToken={token:e,expiresOnTimestamp:n.exp}}getToken(e,t){return C(this,void 0,void 0,(function*(){S(e);const t=w(e);let o;if(t.length){let e;x.info("Get access token with scopes: "+t.join(" "));try{e=yield this.msalClient.acquireTokenOnBehalfOf({oboAssertion:this.ssoToken.token,scopes:t})}catch(e){throw this.generateAuthServerError(e)}if(!e){const e="Access token is null";throw x.error(e),new g(T(m.FailToAcquireTokenOnBehalfOfUser,e),exports.ErrorCode.InternalError)}o={token:e.accessToken,expiresOnTimestamp:e.expiresOn.getTime()}}else{if(x.info("Get SSO token."),Math.floor(Date.now()/1e3)>this.ssoToken.expiresOnTimestamp){const e="Sso token has already expired.";throw x.error(e),new g(e,exports.ErrorCode.TokenExpiredError)}o=this.ssoToken}return o}))}getUserInfo(){return x.info("Get basic user info from SSO token"),function(e){if(!e){const e="SSO token is undefined.";throw x.error(e),new g(e,exports.ErrorCode.InvalidParameter)}const t=A(e),o={displayName:t.name,objectId:t.oid,tenantId:t.tid,preferredUserName:""};return"2.0"===t.ver?o.preferredUserName=t.preferred_username:"1.0"===t.ver&&(o.preferredUserName=t.upn),o}(this.ssoToken.token)}generateAuthServerError(e){const t=e.errorMessage;if("InteractionRequiredAuthError"===e.name){const e="Failed to get access token from AAD server, interaction required: "+t;return x.warn(e),new g(e,exports.ErrorCode.UiRequiredError)}if(t&&t.indexOf("AADSTS50013")>=0){const e="Failed to get access token from AAD server, assertion is invalid because of various reasons: "+t;return x.error(e),new g(e,exports.ErrorCode.TokenExpiredError)}{const e=T(m.FailToAcquireTokenOnBehalfOfUser,t);return x.error(e),new g(e,exports.ErrorCode.ServiceError)}}}const k="invokeResponse";class R{constructor(e,t){this.id=e,this.failureDetail=t}}class b extends i.Dialog{constructor(e,t,o,n){super(o),this.initiateLoginEndpoint=t,this.authConfig=e,this.settings=n,S(this.settings.scopes),function(e){if(e.clientId&&(e.clientSecret||e.certificateContent)&&e.tenantId&&e.authorityHost)return;const t=[];e.clientId||t.push("clientId"),e.clientSecret||e.certificateContent||t.push("clientSecret or certificateContent"),e.tenantId||t.push("tenantId"),e.authorityHost||t.push("authorityHost");const o=T(m.InvalidConfiguration,t.join(", "),"undefined");throw x.error(o),new g(o,exports.ErrorCode.InvalidConfiguration)}(this.authConfig),x.info("Create a new Teams Bot SSO Prompt")}beginDialog(e){return C(this,void 0,void 0,(function*(){var t;x.info("Begin Teams Bot SSO Prompt"),this.ensureMsTeamsChannel(e);let o=9e5;if(this.settings.timeout){if("number"!=typeof this.settings.timeout){const e="type of timeout property in teamsBotSsoPromptSettings should be number.";throw x.error(e),new g(e,exports.ErrorCode.InvalidParameter)}if(this.settings.timeout<=0){const e="value of timeout property in teamsBotSsoPromptSettings should be positive.";throw x.error(e),new g(e,exports.ErrorCode.InvalidParameter)}o=this.settings.timeout}void 0===this.settings.endOnInvalidMessage&&(this.settings.endOnInvalidMessage=!0);const n=null===(t=e.activeDialog)||void 0===t?void 0:t.state;return n.state={},n.options={},n.expires=(new Date).getTime()+o,yield this.sendOAuthCardAsync(e.context),i.Dialog.EndOfTurn}))}continueDialog(e){return C(this,void 0,void 0,(function*(){var t;x.info("Continue Teams Bot SSO Prompt"),this.ensureMsTeamsChannel(e);const o=null===(t=e.activeDialog)||void 0===t?void 0:t.state,r=e.context.activity.type===n.ActivityTypes.Message;if((r||this.isTeamsVerificationInvoke(e.context)||this.isTokenExchangeRequestInvoke(e.context))&&(new Date).getTime()>o.expires)return x.warn("End Teams Bot SSO Prompt due to timeout"),yield e.endDialog(void 0);if(this.isTeamsVerificationInvoke(e.context)||this.isTokenExchangeRequestInvoke(e.context)){const t=yield this.recognizeToken(e);if(t.succeeded)return yield e.endDialog(t.value)}else if(r&&this.settings.endOnInvalidMessage)return x.warn("End Teams Bot SSO Prompt due to invalid message"),yield e.endDialog(void 0);return i.Dialog.EndOfTurn}))}ensureMsTeamsChannel(e){if(e.context.activity.channelId!=n.Channels.Msteams){const e=T(m.OnlyMSTeamsChannelSupported,"Teams Bot SSO Prompt");throw x.error(e),new g(e,exports.ErrorCode.ChannelNotSupported)}}sendOAuthCardAsync(e){return C(this,void 0,void 0,(function*(){x.verbose("Send OAuth card to get SSO token");const t=yield n.TeamsInfo.getMember(e,e.activity.from.id);x.verbose("Get Teams member account user principal name: "+(t.userPrincipalName?t.userPrincipalName:""));const o=t.userPrincipalName?t.userPrincipalName:"",i=this.getSignInResource(o),r=n.CardFactory.oauthCard("","Teams SSO Sign In","Sign In",i.signInLink,i.tokenExchangeResource);r.content.buttons[0].type=n.ActionTypes.Signin;const s=n.MessageFactory.attachment(r);yield e.sendActivity(s)}))}getSignInResource(e){x.verbose("Get sign in authentication configuration");const t=`${this.initiateLoginEndpoint}?scope=${encodeURI(this.settings.scopes.join(" "))}&clientId=${this.authConfig.clientId}&tenantId=${this.authConfig.tenantId}&loginHint=${e}`;x.verbose("Sign in link: "+t);return{signInLink:t,tokenExchangeResource:{id:r.v4()}}}recognizeToken(e){return C(this,void 0,void 0,(function*(){const t=e.context;let o;if(this.isTokenExchangeRequestInvoke(t))if(x.verbose("Receive token exchange request"),t.activity.value&&this.isTokenExchangeRequest(t.activity.value)){const e=t.activity.value.token,i=new E(e,this.authConfig);let r;try{if(r=yield i.getToken(this.settings.scopes),r){yield t.sendActivity(this.getTokenExchangeInvokeResponse(n.StatusCodes.OK,"",t.activity.value.id));const i=A(e).exp;o={ssoToken:e,ssoTokenExpiration:new Date(1e3*i).toISOString(),connectionName:"",token:r.token,expiration:r.expiresOnTimestamp.toString()}}}catch(e){const o="The bot is unable to exchange token. Ask for user consent.";x.info(o),yield t.sendActivity(this.getTokenExchangeInvokeResponse(n.StatusCodes.PRECONDITION_FAILED,o,t.activity.value.id))}}else{const e="The bot received an InvokeActivity that is missing a TokenExchangeInvokeRequest value. This is required to be sent with the InvokeActivity.";x.warn(e),yield t.sendActivity(this.getTokenExchangeInvokeResponse(n.StatusCodes.BAD_REQUEST,e))}else this.isTeamsVerificationInvoke(t)&&(x.verbose("Receive Teams state verification request"),yield this.sendOAuthCardAsync(e.context),yield t.sendActivity({type:k,value:{status:n.StatusCodes.OK}}));return void 0!==o?{succeeded:!0,value:o}:{succeeded:!1}}))}getTokenExchangeInvokeResponse(e,t,o){return{type:k,value:{status:e,body:new R(o,t)}}}isTeamsVerificationInvoke(e){const t=e.activity;return t.type===n.ActivityTypes.Invoke&&t.name===n.verifyStateOperationName}isTokenExchangeRequestInvoke(e){const t=e.activity;return t.type===n.ActivityTypes.Invoke&&t.name===n.tokenExchangeOperationName}isTokenExchangeRequest(e){return e.hasOwnProperty("token")}}var O,P,F,N;exports.ApiKeyLocation=void 0,(O=exports.ApiKeyLocation||(exports.ApiKeyLocation={}))[O.Header=0]="Header",O[O.QueryParams=1]="QueryParams";exports.NotificationTargetType=void 0,(P=exports.NotificationTargetType||(exports.NotificationTargetType={})).Channel="Channel",P.Group="Group",P.Person="Person",exports.AdaptiveCardResponse=void 0,(F=exports.AdaptiveCardResponse||(exports.AdaptiveCardResponse={}))[F.ReplaceForInteractor=0]="ReplaceForInteractor",F[F.ReplaceForAll=1]="ReplaceForAll",F[F.NewForAll=2]="NewForAll",exports.InvokeResponseErrorCode=void 0,(N=exports.InvokeResponseErrorCode||(exports.InvokeResponseErrorCode={}))[N.BadRequest=400]="BadRequest",N[N.InternalServerError=500]="InternalServerError";let D="BotSsoExecutionDialog",M="TeamsFxSsoPrompt",H="CommandRouteDialog";class L extends i.ComponentDialog{constructor(e,t,o,n,r){super(null!=r?r:D),this.dedupStorageKeys=[],this.commandMapping=new Map,r&&(D=r,M=r+M,H=r+H);const s=new b(o,n,M,t);this.addDialog(s),this.initialDialogId=H,this.dedupStorage=e,this.dedupStorageKeys=[];const a=new i.WaterfallDialog(H,[this.commandRouteStep.bind(this)]);this.addDialog(a)}addCommand(e,t){const o=this.getCommandHash(t),n=new i.WaterfallDialog(o,[this.ssoStep.bind(this),this.dedupStep.bind(this),t=>C(this,void 0,void 0,(function*(){const o=t.result.tokenResponse,n=t.context,i=t.result.message;try{if(!o)throw new Error(m.FailedToRetrieveSsoToken);return yield e(n,o,i),yield t.endDialog()}catch(e){const o=T(m.FailedToProcessSsoHandler,e.message);return x.error(o),yield t.endDialog(new g(o,exports.ErrorCode.FailedToProcessSsoHandler))}}))]);this.commandMapping.set(o,t),this.addDialog(n)}getCommandHash(e){const t=(Array.isArray(e)?e:[e]).join();return t.replace(/[^a-zA-Z0-9]/g,"")+o.createHash("sha256").update(t).digest("hex").toLowerCase()}run(e,t){return C(this,void 0,void 0,(function*(){const o=new i.DialogSet(t);o.add(this);const n=yield o.createContext(e);this.ensureMsTeamsChannel(n);const r=yield n.continueDialog();if(r&&r.status===i.DialogTurnStatus.empty)yield n.beginDialog(this.id);else if(r&&r.status===i.DialogTurnStatus.complete&&r.result instanceof Error)throw r.result}))}getActivityText(e){let t=e.text;const o=n.TurnContext.removeRecipientMention(e);return o&&(t=o.toLowerCase().replace(/\n|\r\n/g,"").trim()),t}commandRouteStep(e){return C(this,void 0,void 0,(function*(){const t=e.context,o=this.getActivityText(t.activity),n=this.getMatchesCommandId(o);if(n)return yield e.beginDialog(n);const i=T(m.CannotFindCommand,t.activity.text);throw x.error(i),new g(i,exports.ErrorCode.CannotFindCommand)}))}ssoStep(e){return C(this,void 0,void 0,(function*(){try{const t=e.context,o={text:this.getActivityText(t.activity)};return e.options.commandMessage=o,yield e.beginDialog(M)}catch(t){const o=T(m.FailedToRunSsoStep,t.message);return x.error(o),yield e.endDialog(new g(o,exports.ErrorCode.FailedToRunSsoStep))}}))}dedupStep(e){return C(this,void 0,void 0,(function*(){const t=e.result;if(!t)return x.error(m.FailedToRetrieveSsoToken),yield e.endDialog(new g(m.FailedToRetrieveSsoToken,exports.ErrorCode.FailedToRunSsoStep));try{return t&&(yield this.shouldDedup(e.context))?i.Dialog.EndOfTurn:yield e.next({tokenResponse:t,message:e.options.commandMessage})}catch(t){const o=T(m.FailedToRunDedupStep,t.message);return x.error(o),yield e.endDialog(new g(o,exports.ErrorCode.FailedToRunDedupStep))}}))}onEndDialog(e){return C(this,void 0,void 0,(function*(){const t=e.activity.conversation.id,o=this.dedupStorageKeys.filter((e=>e.indexOf(t)>0));yield this.dedupStorage.delete(o),this.dedupStorageKeys=this.dedupStorageKeys.filter((e=>e.indexOf(t)<0))}))}shouldDedup(e){return C(this,void 0,void 0,(function*(){const t={eTag:e.activity.value.id},o=this.getStorageKey(e),n={[o]:t};try{yield this.dedupStorage.write(n),this.dedupStorageKeys.push(o)}catch(e){if(e instanceof Error&&e.message.indexOf("eTag conflict"))return!0;throw e}return!1}))}getStorageKey(e){if(!e||!e.activity||!e.activity.conversation)throw new Error("Invalid context, can not get storage key!");const t=e.activity,o=t.channelId,i=t.conversation.id;if(t.type!==n.ActivityTypes.Invoke||t.name!==n.tokenExchangeOperationName)throw new Error("TokenExchangeState can only be used with Invokes of signin/tokenExchange.");const r=t.value;if(!r||!r.id)throw new Error("Invalid signin/tokenExchange. Missing activity.value.id.");return`${o}/${i}/${r.id}`}matchPattern(e,t){if(t){if("string"==typeof e){return new RegExp(e,"i").test(t)}if(e instanceof RegExp){const o=t.match(e);return null!=o&&o}}return!1}isPatternMatched(e,t){const o=Array.isArray(e)?e:[e];for(const e of o){return!!this.matchPattern(e,t)}return!1}getMatchesCommandId(e){for(const t of this.commandMapping){const o=t[1];if(this.isPatternMatched(o,e))return t[0]}}ensureMsTeamsChannel(e){if(e.context.activity.channelId!=n.Channels.Msteams){const e=T(m.OnlyMSTeamsChannelSupported,"SSO execution dialog");throw x.error(e),new g(e,exports.ErrorCode.ChannelNotSupported)}}}class B{static attachAdaptiveCard(e,t){const o={$root:t};return{attachments:[n.CardFactory.adaptiveCard(new v.Template(e).expand(o))]}}static attachAdaptiveCardWithoutData(e){return{attachments:[n.CardFactory.adaptiveCard(e)]}}static attachHeroCard(e,t,o,i){return B.attachContent(n.CardFactory.heroCard(e,t,o,i))}static attachSigninCard(e,t,o){return B.attachContent(n.CardFactory.signinCard(e,t,o))}static attachO365ConnectorCard(e){return B.attachContent(n.CardFactory.o365ConnectorCard(e))}static AttachReceiptCard(e){return B.attachContent(n.CardFactory.receiptCard(e))}static attachThumbnailCard(e,t,o,i){return B.attachContent(n.CardFactory.thumbnailCard(e,t,o,i))}static attachContent(e){return{attachments:[e]}}}var q,U,j;!function(e){e.AdaptiveCard="application/vnd.microsoft.card.adaptive",e.Message="application/vnd.microsoft.activity.message",e.Error="application/vnd.microsoft.error"}(q||(q={}));class ${static textMessage(e){if(!e)throw new Error("The text message cannot be null or empty");return{status:n.StatusCodes.OK,body:{statusCode:n.StatusCodes.OK,type:q.Message,value:e}}}static adaptiveCard(e){if(!e)throw new Error("The adaptive card content cannot be null or undefined");return{status:n.StatusCodes.OK,body:{statusCode:n.StatusCodes.OK,type:q.AdaptiveCard,value:e}}}static errorResponse(e,t){return{status:n.StatusCodes.OK,body:{statusCode:e,type:q.Error,value:{code:e.toString(),message:t}}}}static createInvokeResponse(e,t){return{status:e,body:t}}}function K(e,t,o,i,r){return C(this,void 0,void 0,(function*(){const s=e.activity.value;if(!s.authentication||!s.authentication.token)return x.verbose("No AccessToken in request, return silentAuth for AccessToken"),function(e,t,o){const n=w(o);return{composeExtension:{type:"silentAuth",suggestedActions:{actions:[{type:"openUrl",value:`${t}?scope=${encodeURI(n.join(" "))}&clientId=${e.clientId}&tenantId=${e.tenantId}`,title:"Message Extension OAuth"}]}}}}(t,o,i);try{const e=new E(s.authentication.token,t),o=yield e.getToken(i),n=A(s.authentication.token).exp,a={ssoToken:s.authentication.token,ssoTokenExpiration:new Date(1e3*n).toISOString(),token:o.token,expiration:o.expiresOnTimestamp.toString(),connectionName:""};if(r)return yield r(a)}catch(r){if(r instanceof g&&r.code===exports.ErrorCode.UiRequiredError&&"composeExtension/query"===e.activity.name){x.verbose("User not consent yet, return 412 to user consent first.");const t={status:412};return void(yield e.sendActivity({value:t,type:n.ActivityTypes.InvokeResponse}))}if(r instanceof g&&r.code===exports.ErrorCode.UiRequiredError&&"composeExtension/queryLink"===e.activity.name){x.verbose("User not consent yet, return auth card for user login");const r=function(e,t,o){const n=w(o);return{composeExtension:{type:"auth",suggestedActions:{actions:[{type:"openUrl",value:`${t}?scope=${encodeURI(n.join(" "))}&clientId=${e.clientId}&tenantId=${e.tenantId}`,title:"Message Extension OAuth"}]}}}}(t,o,i);return void(yield e.sendActivity({value:{status:200,body:r},type:n.ActivityTypes.InvokeResponse}))}throw r}}))}class z{constructor(e){this.actionHandlers=[],this.defaultMessage="Your response was sent to the app",e&&e.length>0&&this.actionHandlers.push(...e)}onTurn(e,t){return C(this,void 0,void 0,(function*(){var o,i,r;if("adaptiveCard/action"===e.activity.name){const t=e.activity.value.action,s=t.verb;for(const a of this.actionHandlers)if((null===(o=a.triggerVerb)||void 0===o?void 0:o.toLowerCase())===(null==s?void 0:s.toLowerCase())){let o;try{o=yield a.handleActionInvoked(e,t.data)}catch(t){const o=$.errorResponse(exports.InvokeResponseErrorCode.InternalServerError,t.message);throw yield this.sendInvokeResponse(e,o),t}switch(null===(i=o.body)||void 0===i?void 0:i.type){case q.AdaptiveCard:const t=null===(r=o.body)||void 0===r?void 0:r.value;if(!t){const t="Adaptive card content cannot be found in the response body";throw yield this.sendInvokeResponse(e,$.errorResponse(exports.InvokeResponseErrorCode.InternalServerError,t)),new Error(t)}t.refresh&&a.adaptiveCardResponse!==exports.AdaptiveCardResponse.NewForAll&&(a.adaptiveCardResponse=exports.AdaptiveCardResponse.ReplaceForAll);const i=n.MessageFactory.attachment(n.CardFactory.adaptiveCard(t));a.adaptiveCardResponse===exports.AdaptiveCardResponse.NewForAll?(yield this.sendInvokeResponse(e,$.textMessage(this.defaultMessage)),yield e.sendActivity(i)):a.adaptiveCardResponse===exports.AdaptiveCardResponse.ReplaceForAll?(i.id=e.activity.replyToId,yield e.updateActivity(i),yield this.sendInvokeResponse(e,o)):yield this.sendInvokeResponse(e,o);break;case q.Message:case q.Error:default:yield this.sendInvokeResponse(e,o)}break}}yield t()}))}sendInvokeResponse(e,t){return C(this,void 0,void 0,(function*(){yield e.sendActivity({type:n.ActivityTypes.InvokeResponse,value:t})}))}}class G{constructor(e,t){this.middleware=new z(null==t?void 0:t.actions),this.adapter=e.use(this.middleware)}registerHandler(e){e&&this.middleware.actionHandlers.push(e)}registerHandlers(e){e&&this.middleware.actionHandlers.push(...e)}}class Q{constructor(e,t,o){if(this.commandHandlers=[],this.ssoCommandHandlers=[],e=null!=e?e:[],t=null!=t?t:[],this.hasSsoCommand=t.length>0,this.ssoActivityHandler=o,this.hasSsoCommand&&!this.ssoActivityHandler)throw x.error(m.SsoActivityHandlerIsNull),new g(m.SsoActivityHandlerIsNull,exports.ErrorCode.SsoActivityHandlerIsUndefined);this.commandHandlers.push(...e);for(const e of t)this.addSsoCommand(e)}addSsoCommand(e){var t;null===(t=this.ssoActivityHandler)||void 0===t||t.addCommand(((t,o,n)=>C(this,void 0,void 0,(function*(){const i=this.shouldTrigger(e.triggerPatterns,n.text);n.matches=Array.isArray(i)?i:void 0;const r=yield e.handleCommandReceived(t,n,o);yield this.processResponse(t,r)}))),e.triggerPatterns),this.ssoCommandHandlers.push(e),this.hasSsoCommand=!0}onTurn(e,t){return C(this,void 0,void 0,(function*(){var o,i;if(e.activity.type===n.ActivityTypes.Message){const t=this.getActivityText(e.activity);let n=!1;for(const o of this.commandHandlers){const i=this.shouldTrigger(o.triggerPatterns,t);if(i){const r={text:t};r.matches=Array.isArray(i)?i:void 0;const s=yield o.handleCommandReceived(e,r);yield this.processResponse(e,s),n=!0;break}}if(!n)for(const n of this.ssoCommandHandlers){if(this.shouldTrigger(n.triggerPatterns,t)){yield null===(o=this.ssoActivityHandler)||void 0===o?void 0:o.run(e);break}}}else this.hasSsoCommand&&(yield null===(i=this.ssoActivityHandler)||void 0===i?void 0:i.run(e));yield t()}))}processResponse(e,t){return C(this,void 0,void 0,(function*(){if("string"==typeof t)yield e.sendActivity(t);else{const o=t;o&&(yield e.sendActivity(o))}}))}matchPattern(e,t){if(t){if("string"==typeof e){return new RegExp(e,"i").test(t)}if(e instanceof RegExp){const o=t.match(e);return null!=o&&o}}return!1}shouldTrigger(e,t){const o=Array.isArray(e)?e:[e];for(const e of o){const o=this.matchPattern(e,t);if(o)return o}return!1}getActivityText(e){let t=e.text;const o=n.TurnContext.removeRecipientMention(e);return o&&(t=o.toLowerCase().replace(/\n|\r\n/g,"").trim()),t}}class _{constructor(e,t,o,n){this.ssoConfig=n,this.middleware=new Q(null==t?void 0:t.commands,null==t?void 0:t.ssoCommands,o),this.adapter=e.use(this.middleware)}registerCommand(e){e&&this.middleware.commandHandlers.push(e)}registerCommands(e){e&&this.middleware.commandHandlers.push(...e)}registerSsoCommand(e){this.validateSsoActivityHandler(),this.middleware.addSsoCommand(e)}registerSsoCommands(e){if(e.length>0){this.validateSsoActivityHandler();for(const t of e)this.middleware.addSsoCommand(t)}}validateSsoActivityHandler(){if(!this.middleware.ssoActivityHandler)throw x.error(m.SsoActivityHandlerIsNull),new g(m.SsoActivityHandlerIsNull,exports.ErrorCode.SsoActivityHandlerIsUndefined)}}function V(e){return JSON.parse(JSON.stringify(e))}function W(e){var t,o;return`_${null===(t=e.conversation)||void 0===t?void 0:t.tenantId}_${null===(o=e.conversation)||void 0===o?void 0:o.id}`}function J(e){var t,o,n;const i=null===(n=null===(o=null===(t=e.activity)||void 0===t?void 0:t.channelData)||void 0===o?void 0:o.team)||void 0===n?void 0:n.id;return i||(void 0===e.activity.conversation.name?e.activity.conversation.id:void 0)}!function(e){e[e.CurrentBotInstalled=0]="CurrentBotInstalled",e[e.CurrentBotMessaged=1]="CurrentBotMessaged",e[e.CurrentBotUninstalled=2]="CurrentBotUninstalled",e[e.TeamDeleted=3]="TeamDeleted",e[e.TeamRestored=4]="TeamRestored",e[e.Unknown=5]="Unknown"}(U||(U={}));class Z{constructor(e){this.conversationReferenceStore=e.conversationReferenceStore}onTurn(e,t){return C(this,void 0,void 0,(function*(){switch(this.classifyActivity(e.activity)){case U.CurrentBotInstalled:case U.TeamRestored:{const t=n.TurnContext.getConversationReference(e.activity);yield this.conversationReferenceStore.add(W(t),t,{overwrite:!0});break}case U.CurrentBotMessaged:yield this.tryAddMessagedReference(e);break;case U.CurrentBotUninstalled:case U.TeamDeleted:{const t=n.TurnContext.getConversationReference(e.activity);yield this.conversationReferenceStore.remove(W(t),t);break}}yield t()}))}classifyActivity(e){var t,o;const n=e.type;if("installationUpdate"===n){const o=null===(t=e.action)||void 0===t?void 0:t.toLowerCase();return"add"===o||"add-upgrade"===o?U.CurrentBotInstalled:U.CurrentBotUninstalled}if("conversationUpdate"===n){const t=null===(o=e.channelData)||void 0===o?void 0:o.eventType;if("teamDeleted"===t)return U.TeamDeleted;if("teamRestored"===t)return U.TeamRestored}else if("message"===n)return U.CurrentBotMessaged;return U.Unknown}tryAddMessagedReference(e){return C(this,void 0,void 0,(function*(){var t,o,i,r,s,a;const d=n.TurnContext.getConversationReference(e.activity),c=null===(t=null==d?void 0:d.conversation)||void 0===t?void 0:t.conversationType;if("personal"===c||"groupChat"===c)yield this.conversationReferenceStore.add(W(d),d,{overwrite:!1});else if("channel"===c){const t=null===(r=null===(i=null===(o=e.activity)||void 0===o?void 0:o.channelData)||void 0===i?void 0:i.team)||void 0===r?void 0:r.id,n=null===(a=null===(s=e.activity.channelData)||void 0===s?void 0:s.channel)||void 0===a?void 0:a.id;if(void 0!==t&&(void 0===n||t===n)){const e=V(d);e.conversation.id=t,yield this.conversationReferenceStore.add(W(e),e,{overwrite:!1})}}}))}}class X{constructor(e){var t;this.localFileName=null!==(t=process.env.TEAMSFX_NOTIFICATION_STORE_FILENAME)&&void 0!==t?t:".notification.localstore.json",this.filePath=y.resolve(e,this.localFileName)}add(e,t,o){return C(this,void 0,void 0,(function*(){if(o.overwrite||!(yield this.storeFileExists())){if(yield this.storeFileExists()){const o=yield this.readFromFile();yield this.writeToFile(Object.assign(o,{[e]:t}))}else yield this.writeToFile({[e]:t});return!0}return!1}))}remove(e,t){return C(this,void 0,void 0,(function*(){if(!(yield this.storeFileExists()))return!1;if(yield this.storeFileExists()){const t=yield this.readFromFile();void 0!==t[e]&&(delete t[e],yield this.writeToFile(t))}return!0}))}list(e,t){return C(this,void 0,void 0,(function*(){if(!(yield this.storeFileExists()))return{data:[],continuationToken:""};const e=yield this.readFromFile();return{data:Object.entries(e).map((e=>e[1])),continuationToken:""}}))}storeFileExists(){return new Promise((e=>{try{f.access(this.filePath,(t=>{e(!t)}))}catch(t){e(!1)}}))}readFromFile(){return new Promise(((e,t)=>{try{f.readFile(this.filePath,{encoding:"utf-8"},((o,n)=>{o?t(o):e(JSON.parse(n))}))}catch(e){t(e)}}))}writeToFile(e){return C(this,void 0,void 0,(function*(){return new Promise(((t,o)=>{try{const n=JSON.stringify(e,void 0,2);f.writeFile(this.filePath,n,{encoding:"utf-8"},(e=>{e?o(e):t()}))}catch(e){o(e)}}))}))}}class Y{constructor(e,t){this.type=exports.NotificationTargetType.Channel,this.parent=e,this.info=t}sendMessage(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(n=>C(this,void 0,void 0,(function*(){const i=yield this.newConversation(n);yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,i,(n=>C(this,void 0,void 0,(function*(){try{const t=yield n.sendActivity(e);o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(n,e)}}))))})))),o}))}sendAdaptiveCard(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(i=>C(this,void 0,void 0,(function*(){const r=yield this.newConversation(i);yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,r,(i=>C(this,void 0,void 0,(function*(){try{const t=yield i.sendActivity({attachments:[n.CardFactory.adaptiveCard(e)]});o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(i,e)}}))))})))),o}))}newConversation(e){const t=V(n.TurnContext.getConversationReference(e.activity));return t.conversation.id=this.info.id||"",Promise.resolve(t)}}class ee{constructor(e,t){this.type=exports.NotificationTargetType.Person,this.parent=e,this.account=t}sendMessage(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(n=>C(this,void 0,void 0,(function*(){const i=yield this.newConversation(n);yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,i,(n=>C(this,void 0,void 0,(function*(){try{const t=yield n.sendActivity(e);o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(n,e)}}))))})))),o}))}sendAdaptiveCard(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(i=>C(this,void 0,void 0,(function*(){const r=yield this.newConversation(i);yield this.parent.adapter.continueConversationAsync(this.parent.botAppId,r,(i=>C(this,void 0,void 0,(function*(){try{const t=yield i.sendActivity({attachments:[n.CardFactory.adaptiveCard(e)]});o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(i,e)}}))))})))),o}))}newConversation(e){return C(this,void 0,void 0,(function*(){const t=V(n.TurnContext.getConversationReference(e.activity)),o=e.turnState.get(this.parent.adapter.ConnectorClientKey),i=yield o.conversations.createConversation({isGroup:!1,tenantId:e.activity.conversation.tenantId,bot:e.activity.recipient,members:[this.account],channelData:{}});return t.conversation.id=i.id,t}))}}class te{constructor(e,t,o){this.adapter=e,this.conversationReference=t,this.type=function(e){var t;const o=null===(t=e.conversation)||void 0===t?void 0:t.conversationType;return"personal"===o?exports.NotificationTargetType.Person:"groupChat"===o?exports.NotificationTargetType.Group:"channel"===o?exports.NotificationTargetType.Channel:void 0}(t),this.botAppId=o}sendMessage(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(n=>C(this,void 0,void 0,(function*(){try{const t=yield n.sendActivity(e);o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(n,e)}})))),o}))}sendAdaptiveCard(e,t){return C(this,void 0,void 0,(function*(){const o={};return yield this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(i=>C(this,void 0,void 0,(function*(){try{const t=yield i.sendActivity({attachments:[n.CardFactory.adaptiveCard(e)]});o.id=null==t?void 0:t.id}catch(e){if(!t)throw e;yield t(i,e)}})))),o}))}channels(){return C(this,void 0,void 0,(function*(){const e=[];if(this.type!==exports.NotificationTargetType.Channel)return e;let t=[];yield this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(e=>C(this,void 0,void 0,(function*(){const o=J(e);void 0!==o&&(t=yield n.TeamsInfo.getTeamChannels(e,o))}))));for(const o of t)e.push(new Y(this,o));return e}))}getPagedMembers(e,t){return C(this,void 0,void 0,(function*(){let o={data:[],continuationToken:""};return yield this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(i=>C(this,void 0,void 0,(function*(){const r=yield n.TeamsInfo.getPagedMembers(i,e,t);o={data:r.members.map((e=>new ee(this,e))),continuationToken:r.continuationToken}})))),o}))}getTeamDetails(){return C(this,void 0,void 0,(function*(){if(this.type!==exports.NotificationTargetType.Channel)return;let e;return yield this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(t=>C(this,void 0,void 0,(function*(){const o=J(t);void 0!==o&&(e=yield n.TeamsInfo.getTeamDetails(t,o))})))),e}))}}class oe{constructor(e,t){var o,n;(null==t?void 0:t.store)?this.conversationReferenceStore=t.store:this.conversationReferenceStore=new X(y.resolve("1"===process.env.RUNNING_ON_AZURE&&null!==(o=process.env.TEMP)&&void 0!==o?o:"./")),this.adapter=e.use(new Z({conversationReferenceStore:this.conversationReferenceStore})),this.botAppId=null!==(n=null==t?void 0:t.botAppId)&&void 0!==n?n:process.env.BOT_ID}buildTeamsBotInstallation(e){if(!e)throw new Error("conversationReference is required.");return new te(this.adapter,e,this.botAppId)}validateInstallation(e){return C(this,void 0,void 0,(function*(){let t=!0;return yield this.adapter.continueConversationAsync(this.botAppId,e,(e=>C(this,void 0,void 0,(function*(){try{yield n.TeamsInfo.getPagedMembers(e,1)}catch(e){"BotNotInConversationRoster"===e.code&&(t=!1)}})))),t}))}getPagedInstallations(e,t){return C(this,arguments,void 0,(function*(e,t,o=!0){if(void 0===this.conversationReferenceStore||void 0===this.adapter)throw new Error("NotificationBot has not been initialized.");const n=yield this.conversationReferenceStore.list(e,t),i=[];for(const e of n.data){let t;o&&(t=yield this.validateInstallation(e)),!o||o&&t?i.push(new te(this.adapter,e,this.botAppId)):yield this.conversationReferenceStore.remove(W(e),e)}return{data:i,continuationToken:n.continuationToken}}))}findMember(e,t){return C(this,void 0,void 0,(function*(){for(const o of yield this.installations())if(this.matchSearchScope(o,t)){const t=[];let n;do{const e=yield o.getPagedMembers(void 0,n);n=e.continuationToken,t.push(...e.data)}while(n);for(const o of t)if(yield e(o))return o}}))}findChannel(e){return C(this,void 0,void 0,(function*(){for(const t of yield this.installations())if(t.type===exports.NotificationTargetType.Channel){const o=yield t.getTeamDetails();for(const n of yield t.channels())if(yield e(n,o))return n}}))}findAllMembers(e,t){return C(this,void 0,void 0,(function*(){const o=[];for(const n of yield this.installations())if(this.matchSearchScope(n,t)){const t=[];let i;do{const e=yield n.getPagedMembers(void 0,i);i=e.continuationToken,t.push(...e.data)}while(i);for(const n of t)(yield e(n))&&o.push(n)}return o}))}findAllChannels(e){return C(this,void 0,void 0,(function*(){const t=[];for(const o of yield this.installations())if(o.type===exports.NotificationTargetType.Channel){const n=yield o.getTeamDetails();for(const i of yield o.channels())(yield e(i,n))&&t.push(i)}return t}))}matchSearchScope(e,t){return t=null!=t?t:j.All,e.type===exports.NotificationTargetType.Channel&&0!=(t&j.Channel)||e.type===exports.NotificationTargetType.Group&&0!=(t&j.Group)||e.type===exports.NotificationTargetType.Person&&0!=(t&j.Person)}installations(){return C(this,void 0,void 0,(function*(){let e;const t=[];do{const o=yield this.getPagedInstallations(void 0,e);e=o.continuationToken,t.push(...o.data)}while(e);return t}))}}!function(e){e[e.Person=1]="Person",e[e.Group=2]="Group",e[e.Channel=4]="Channel",e[e.All=7]="All"}(j||(j={}));class ne extends n.TeamsActivityHandler{constructor(e){var t,o,i,r,s,a,d,c,l,u;super();const h=new n.MemoryStorage,p=null!==(o=null===(t=e.dialog)||void 0===t?void 0:t.userState)&&void 0!==o?o:new n.UserState(h),v=null!==(r=null===(i=e.dialog)||void 0===i?void 0:i.conversationState)&&void 0!==r?r:new n.ConversationState(h),y=null!==(a=null===(s=e.dialog)||void 0===s?void 0:s.dedupStorage)&&void 0!==a?a:h,f=e.aad,{scopes:m}=f,g=function(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(o[n[i]]=e[n[i]])}return o}(f,["scopes"]),x={scopes:m,timeout:null===(c=null===(d=e.dialog)||void 0===d?void 0:d.ssoPromptConfig)||void 0===c?void 0:c.timeout,endOnInvalidMessage:null===(u=null===(l=e.dialog)||void 0===l?void 0:l.ssoPromptConfig)||void 0===u?void 0:u.endOnInvalidMessage};this.ssoExecutionDialog=new L(y,x,g,g.initiateLoginEndpoint),this.conversationState=v,this.dialogState=v.createProperty("DialogState"),this.userState=p,this.onMessage(((e,t)=>C(this,void 0,void 0,(function*(){yield this.ssoExecutionDialog.run(e,this.dialogState),yield t()}))))}addCommand(e,t){this.ssoExecutionDialog.addCommand(e,t)}run(e){const t=Object.create(null,{run:{get:()=>super.run}});return C(this,void 0,void 0,(function*(){try{yield t.run.call(this,e)}finally{yield this.conversationState.saveChanges(e,!1),yield this.userState.saveChanges(e,!1)}}))}handleTeamsSigninVerifyState(e,t){return C(this,void 0,void 0,(function*(){yield this.ssoExecutionDialog.run(e,this.dialogState)}))}handleTeamsSigninTokenExchange(e,t){return C(this,void 0,void 0,(function*(){yield this.ssoExecutionDialog.run(e,this.dialogState)}))}}var ie=Object.freeze({__proto__:null,BotSsoExecutionDialog:L,CardActionBot:G,Channel:Y,CommandBot:_,ConversationBot:class{constructor(e){var t,o,n,i;let r;e.adapter?this.adapter=e.adapter:this.adapter=this.createDefaultAdapter(e.adapterConfig),(null==e?void 0:e.ssoConfig)&&(r=(null===(t=e.ssoConfig.dialog)||void 0===t?void 0:t.CustomBotSsoExecutionActivityHandler)?new e.ssoConfig.dialog.CustomBotSsoExecutionActivityHandler(e.ssoConfig):new ne(e.ssoConfig)),(null===(o=e.command)||void 0===o?void 0:o.enabled)&&(this.command=new _(this.adapter,e.command,r,e.ssoConfig)),(null===(n=e.notification)||void 0===n?void 0:n.enabled)&&(this.notification=new oe(this.adapter,e.notification)),(null===(i=e.cardAction)||void 0===i?void 0:i.enabled)&&(this.cardAction=new G(this.adapter,e.cardAction))}createDefaultAdapter(e){const t=void 0===e?new n.ConfigurationServiceClientCredentialFactory({MicrosoftAppId:process.env.BOT_ID,MicrosoftAppPassword:process.env.BOT_PASSWORD,MicrosoftAppType:"MultiTenant"}):new n.ConfigurationServiceClientCredentialFactory(e),o=new n.ConfigurationBotFrameworkAuthentication({},t),i=new n.CloudAdapter(o);return i.onTurnError=(e,t)=>C(this,void 0,void 0,(function*(){console.error("[onTurnError] unhandled error",t),"message"===e.activity.type&&(yield e.sendTraceActivity("OnTurnError Trace",t instanceof Error?t.message:t,"https://www.botframework.com/schemas/error","TurnError"),yield e.sendActivity(`The bot encountered unhandled error: ${t.message}`),yield e.sendActivity("To continue to run this bot, please fix the bot source code."))})),i}requestHandler(e,t,o){return C(this,void 0,void 0,(function*(){void 0===o&&(o=()=>C(this,void 0,void 0,(function*(){}))),yield this.adapter.process(e,t,o)}))}},Member:ee,NotificationBot:oe,get SearchScope(){return j},TeamsBotInstallation:te,sendAdaptiveCard:function(e,t,o){return e.sendAdaptiveCard(t,o)},sendMessage:function(e,t,o){return e.sendMessage(t,o)}});exports.ApiKeyProvider=class{constructor(e,t,o){if(!e)throw new g(T(m.EmptyParameter,"keyName"),exports.ErrorCode.InvalidParameter);if(!t)throw new g(T(m.EmptyParameter,"keyVaule"),exports.ErrorCode.InvalidParameter);this.keyName=e,this.keyValue=t,this.keyLocation=o}AddAuthenticationInfo(e){switch(this.keyLocation){case exports.ApiKeyLocation.Header:if(e.headers||(e.headers={}),e.headers[this.keyName])return Promise.reject(new g(T(m.DuplicateApiKeyInHeader,this.keyName),exports.ErrorCode.AuthorizationInfoAlreadyExists));e.headers[this.keyName]=this.keyValue;break;case exports.ApiKeyLocation.QueryParams:e.params||(e.params={});let t=!1;if(e.url){t=new URL(e.url,e.baseURL).searchParams.has(this.keyName)}if(e.params[this.keyName]||t)return Promise.reject(new g(T(m.DuplicateApiKeyInQueryParam,this.keyName),exports.ErrorCode.AuthorizationInfoAlreadyExists));e.params[this.keyName]=this.keyValue}return Promise.resolve(e)}},exports.AppCredential=class{constructor(e){x.info("Create M365 tenant credential");const t=this.loadAndValidateConfig(e);this.msalClient=I(t)}getToken(e,t){return C(this,void 0,void 0,(function*(){let t;S(e);const o="string"==typeof e?e:e.join(" ");x.info("Get access token with scopes: "+o);try{const o=w(e),n=yield this.msalClient.acquireTokenByClientCredential({scopes:o});n&&(t={token:n.accessToken,expiresOnTimestamp:n.expiresOn.getTime()})}catch(e){const t="Get M365 tenant credential failed with error: "+e.message;throw x.error(t),new g(t,exports.ErrorCode.ServiceError)}if(!t){const e="Get M365 tenant credential access token failed with empty access token";throw x.error(e),new g(e,exports.ErrorCode.InternalError)}return t}))}loadAndValidateConfig(e){if(x.verbose("Validate authentication configuration"),e.clientId&&(e.clientSecret||e.certificateContent)&&e.tenantId&&e.authorityHost)return e;const t=[];e.clientId||t.push("clientId"),e.clientSecret||e.certificateContent||t.push("clientSecret or certificateContent"),e.tenantId||t.push("tenantId"),e.authorityHost||t.push("authorityHost");const o=T(m.InvalidConfiguration,t.join(", "),"undefined");throw x.error(o),new g(o,exports.ErrorCode.InvalidConfiguration)}},exports.BasicAuthProvider=class{constructor(e,t){if(!e)throw new g(T(m.EmptyParameter,"username"),exports.ErrorCode.InvalidParameter);if(!t)throw new g(T(m.EmptyParameter,"password"),exports.ErrorCode.InvalidParameter);this.userName=e,this.password=t}AddAuthenticationInfo(e){return e.headers&&e.headers.Authorization?Promise.reject(new g(m.AuthorizationHeaderAlreadyExists,exports.ErrorCode.AuthorizationInfoAlreadyExists)):e.auth?Promise.reject(new g(m.BasicCredentialAlreadyExists,exports.ErrorCode.AuthorizationInfoAlreadyExists)):(e.auth={username:this.userName,password:this.password},Promise.resolve(e))}},exports.BearerTokenAuthProvider=class{constructor(e){this.getToken=e}AddAuthenticationInfo(e){return C(this,void 0,void 0,(function*(){const t=yield this.getToken();if(e.headers||(e.headers={}),e.headers.Authorization)throw new g(m.AuthorizationHeaderAlreadyExists,exports.ErrorCode.AuthorizationInfoAlreadyExists);return e.headers.Authorization=`Bearer ${t}`,e}))}},exports.BotBuilderCloudAdapter=ie,exports.BotSsoExecutionDialog=L,exports.CertificateAuthProvider=class{constructor(e){if(!e||0===Object.keys(e).length)throw new g(T(m.EmptyParameter,"certOption"),exports.ErrorCode.InvalidParameter);this.certOption=e}AddAuthenticationInfo(e){if(e.httpsAgent){const t=new Set(Object.keys(e.httpsAgent.options));for(const e of Object.keys(this.certOption))if(t.has(e))return Promise.reject(new g(T(m.DuplicateHttpsOptionProperty,e),exports.ErrorCode.InvalidParameter));Object.assign(e.httpsAgent.options,this.certOption)}else e.httpsAgent=new a.Agent(this.certOption);return Promise.resolve(e)}},exports.ErrorWithCode=g,exports.InvokeResponseFactory=$,exports.MessageBuilder=B,exports.OnBehalfOfUserCredential=E,exports.TeamsBotSsoPrompt=b,exports.TeamsUserCredential=class{constructor(e){throw new g(T(m.NodejsRuntimeNotSupported,"TeamsUserCredential"),exports.ErrorCode.RuntimeNotSupported)}login(e,t){return Promise.reject(new g(T(m.NodejsRuntimeNotSupported,"TeamsUserCredential"),exports.ErrorCode.RuntimeNotSupported))}getToken(e,t){return Promise.reject(new g(T(m.NodejsRuntimeNotSupported,"TeamsUserCredential"),exports.ErrorCode.RuntimeNotSupported))}getUserInfo(e){return Promise.reject(new g(T(m.NodejsRuntimeNotSupported,"TeamsUserCredential"),exports.ErrorCode.RuntimeNotSupported))}},exports.createApiClient=function(e,t){const o=s.create({baseURL:e});return o.interceptors.request.use((function(e){return C(this,void 0,void 0,(function*(){return yield t.AddAuthenticationInfo(e)}))})),o},exports.createPemCertOption=function(e,t,o){if(0===e.length)throw new g(T(m.EmptyParameter,"cert"),exports.ErrorCode.InvalidParameter);if(0===t.length)throw new g(T(m.EmptyParameter,"key"),exports.ErrorCode.InvalidParameter);return{cert:e,key:t,passphrase:null==o?void 0:o.passphrase,ca:null==o?void 0:o.ca}},exports.createPfxCertOption=function(e,t){if(0===e.length)throw new g(T(m.EmptyParameter,"pfx"),exports.ErrorCode.InvalidParameter);return{pfx:e,passphrase:null==t?void 0:t.passphrase}},exports.getLogLevel=function(){return x.level},exports.handleMessageExtensionLinkQueryWithSSO=function(e,t,o,n,i){return C(this,void 0,void 0,(function*(){if("composeExtension/queryLink"!=e.activity.name)throw x.error(m.OnlySupportInLinkQueryActivity),new g(T(m.OnlySupportInLinkQueryActivity),exports.ErrorCode.FailedOperation);return yield K(e,null!=t?t:{},o,n,i)}))},exports.handleMessageExtensionQueryWithSSO=function(e,t,o,n,i){return C(this,void 0,void 0,(function*(){if("composeExtension/query"!=e.activity.name)throw x.error(m.OnlySupportInQueryActivity),new g(T(m.OnlySupportInQueryActivity),exports.ErrorCode.FailedOperation);return yield K(e,null!=t?t:{},o,n,i)}))},exports.setLogFunction=function(e){x.customLogFunction=e},exports.setLogLevel=function(e){x.level=e},exports.setLogger=function(e){x.customLogger=e};
//# sourceMappingURL=index.node.cjs.js.map
