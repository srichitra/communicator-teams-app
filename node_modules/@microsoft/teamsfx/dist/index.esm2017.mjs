import{jwtDecode as e}from"jwt-decode";import{ConfidentialClientApplication as t}from"@azure/msal-node";import{createHash as n}from"crypto";import{ActivityTypes as i,Channels as o,TeamsInfo as a,CardFactory as r,ActionTypes as s,MessageFactory as c,StatusCodes as d,verifyStateOperationName as l,tokenExchangeOperationName as u,TurnContext as h,TeamsActivityHandler as p,MemoryStorage as v,UserState as m,ConversationState as f,ConfigurationServiceClientCredentialFactory as y,ConfigurationBotFrameworkAuthentication as g,CloudAdapter as w}from"botbuilder";import{Dialog as C,ComponentDialog as A,WaterfallDialog as S,DialogSet as I,DialogTurnStatus as T}from"botbuilder-dialogs";import{v4 as k}from"uuid";import E from"axios";import{Agent as x}from"https";import*as R from"adaptivecards-templating";import*as b from"path";import*as O from"fs";var P,F;!function(e){e.InvalidParameter="InvalidParameter",e.InvalidConfiguration="InvalidConfiguration",e.InvalidCertificate="InvalidCertificate",e.InternalError="InternalError",e.ChannelNotSupported="ChannelNotSupported",e.FailedToRetrieveSsoToken="FailedToRetrieveSsoToken",e.FailedToProcessSsoHandler="FailedToProcessSsoHandler",e.CannotFindCommand="CannotFindCommand",e.FailedToRunSsoStep="FailedToRunSsoStep",e.FailedToRunDedupStep="FailedToRunDedupStep",e.SsoActivityHandlerIsUndefined="SsoActivityHandlerIsUndefined",e.RuntimeNotSupported="RuntimeNotSupported",e.ConsentFailed="ConsentFailed",e.UiRequiredError="UiRequiredError",e.TokenExpiredError="TokenExpiredError",e.ServiceError="ServiceError",e.FailedOperation="FailedOperation",e.InvalidResponse="InvalidResponse",e.AuthorizationInfoAlreadyExists="AuthorizationInfoAlreadyExists"}(P||(P={}));class D{}D.InvalidConfiguration="{0} in configuration is invalid: {1}.",D.ConfigurationNotExists="Configuration does not exist. {0}",D.ResourceConfigurationNotExists="{0} resource configuration does not exist.",D.MissingResourceConfiguration="Missing resource configuration with type: {0}, name: {1}.",D.AuthenticationConfigurationNotExists="Authentication configuration does not exist.",D.BrowserRuntimeNotSupported="{0} is not supported in browser.",D.NodejsRuntimeNotSupported="{0} is not supported in Node.",D.FailToAcquireTokenOnBehalfOfUser="Failed to acquire access token on behalf of user: {0}",D.OnlyMSTeamsChannelSupported="{0} is only supported in MS Teams Channel",D.FailedToProcessSsoHandler="Failed to process sso handler: {0}",D.FailedToRetrieveSsoToken="Failed to retrieve sso token, user failed to finish the AAD consent flow.",D.CannotFindCommand="Cannot find command: {0}",D.FailedToRunSsoStep="Failed to run dialog to retrieve sso token: {0}",D.FailedToRunDedupStep="Failed to run dialog to remove duplicated messages: {0}",D.SsoActivityHandlerIsNull="Sso command can only be used or added when sso activity handler is not undefined",D.AuthorizationHeaderAlreadyExists="Authorization header already exists!",D.BasicCredentialAlreadyExists="Basic credential already exists!",D.EmptyParameter="Parameter {0} is empty",D.DuplicateHttpsOptionProperty="Axios HTTPS agent already defined value for property {0}",D.DuplicateApiKeyInHeader="The request already defined api key in request header with name {0}.",D.DuplicateApiKeyInQueryParam="The request already defined api key in query parameter with name {0}.",D.OnlySupportInQueryActivity="The handleMessageExtensionQueryWithToken only support in handleTeamsMessagingExtensionQuery with composeExtension/query type.",D.OnlySupportInLinkQueryActivity="The handleMessageExtensionLinkQueryWithSSO only support in handleTeamsAppBasedLinkQuery with composeExtension/queryLink type.";class M extends Error{constructor(e,t){if(!t)return super(e),this;super(e),Object.setPrototypeOf(this,M.prototype),this.name=`${new.target.name}.${t}`,this.code=t}}function N(e){B.level=e}function H(){return B.level}!function(e){e[e.Verbose=0]="Verbose",e[e.Info=1]="Info",e[e.Warn=2]="Warn",e[e.Error=3]="Error"}(F||(F={}));const B=new class{constructor(e,t){this.level=void 0,this.defaultLogger={verbose:console.debug,info:console.info,warn:console.warn,error:console.error},this.name=e,this.level=t}error(e){this.log(F.Error,(e=>e.error),e)}warn(e){this.log(F.Warn,(e=>e.warn),e)}info(e){this.log(F.Info,(e=>e.info),e)}verbose(e){this.log(F.Verbose,(e=>e.verbose),e)}log(e,t,n){if(""===n.trim())return;const i=(new Date).toUTCString();let o;o=this.name?`[${i}] : @microsoft/teamsfx - ${this.name} : ${F[e]} - `:`[${i}] : @microsoft/teamsfx : ${F[e]} - `;const a=`${o}${n}`;void 0!==this.level&&this.level<=e&&(this.customLogger?t(this.customLogger)(a):this.customLogFunction?this.customLogFunction(e,a):t(this.defaultLogger)(a))}};function U(e){B.customLogger=e}function q(e){B.customLogFunction=e}function j(t){try{const n=e(t);if(!n||!n.exp)throw new M("Decoded token is null or exp claim does not exists.",P.InternalError);return n}catch(e){const t="Parse jwt token failed in node env with error: "+e.message;throw B.error(t),new M(t,P.InternalError)}}function L(e,...t){const n=t;return e.replace(/{(\d+)}/g,(function(e,t){return void 0!==n[t]?n[t]:e}))}function $(e){if("string"==typeof e||e instanceof String)return;if(Array.isArray(e)&&0===e.length)return;if(Array.isArray(e)&&e.length>0&&e.every((e=>"string"==typeof e)))return;const t="The type of scopes is not valid, it must be string or string array";throw B.error(t),new M(t,P.InvalidParameter)}function z(e){return("string"==typeof e?e.split(" "):e).filter((e=>null!==e&&""!==e))}function K(e){const i=(o=e.authorityHost,a=e.tenantId,o.replace(/\/+$/g,"")+"/"+a);var o,a;const r=function(e){if(!e)return;const t=/(-+BEGIN CERTIFICATE-+)(\n\r?|\r\n?)([A-Za-z0-9+/\n\r]+=*)(\n\r?|\r\n?)(-+END CERTIFICATE-+)/.exec(e);if(!t){const e="The certificate content does not contain a PEM-encoded certificate.";throw B.error(e),new M(e,P.InvalidCertificate)}return{thumbprintSha256:n("sha256").update(Buffer.from(t[3],"base64")).digest("hex").toUpperCase(),privateKey:e}}(e.certificateContent),s={clientId:e.clientId,authority:i};return r?s.clientCertificate=r:s.clientSecret=e.clientSecret,new t({auth:s})}class G{constructor(e){B.info("Create M365 tenant credential");const t=this.loadAndValidateConfig(e);this.msalClient=K(t)}async getToken(e,t){let n;$(e);const i="string"==typeof e?e:e.join(" ");B.info("Get access token with scopes: "+i);try{const t=z(e),i=await this.msalClient.acquireTokenByClientCredential({scopes:t});i&&(n={token:i.accessToken,expiresOnTimestamp:i.expiresOn.getTime()})}catch(e){const t="Get M365 tenant credential failed with error: "+e.message;throw B.error(t),new M(t,P.ServiceError)}if(!n){const e="Get M365 tenant credential access token failed with empty access token";throw B.error(e),new M(e,P.InternalError)}return n}loadAndValidateConfig(e){if(B.verbose("Validate authentication configuration"),e.clientId&&(e.clientSecret||e.certificateContent)&&e.tenantId&&e.authorityHost)return e;const t=[];e.clientId||t.push("clientId"),e.clientSecret||e.certificateContent||t.push("clientSecret or certificateContent"),e.tenantId||t.push("tenantId"),e.authorityHost||t.push("authorityHost");const n=L(D.InvalidConfiguration,t.join(", "),"undefined");throw B.error(n),new M(n,P.InvalidConfiguration)}}class _{constructor(e,t){B.info("Get on behalf of user credential");const n=[];if(t.clientId||n.push("clientId"),t.authorityHost||n.push("authorityHost"),t.clientSecret||t.certificateContent||n.push("clientSecret or certificateContent"),t.tenantId||n.push("tenantId"),0!=n.length){const e=L(D.InvalidConfiguration,n.join(", "),"undefined");throw B.error(e),new M(e,P.InvalidConfiguration)}this.msalClient=K(t);const i=j(e);this.ssoToken={token:e,expiresOnTimestamp:i.exp}}async getToken(e,t){$(e);const n=z(e);let i;if(n.length){let e;B.info("Get access token with scopes: "+n.join(" "));try{e=await this.msalClient.acquireTokenOnBehalfOf({oboAssertion:this.ssoToken.token,scopes:n})}catch(e){throw this.generateAuthServerError(e)}if(!e){const e="Access token is null";throw B.error(e),new M(L(D.FailToAcquireTokenOnBehalfOfUser,e),P.InternalError)}i={token:e.accessToken,expiresOnTimestamp:e.expiresOn.getTime()}}else{if(B.info("Get SSO token."),Math.floor(Date.now()/1e3)>this.ssoToken.expiresOnTimestamp){const e="Sso token has already expired.";throw B.error(e),new M(e,P.TokenExpiredError)}i=this.ssoToken}return i}getUserInfo(){return B.info("Get basic user info from SSO token"),function(e){if(!e){const e="SSO token is undefined.";throw B.error(e),new M(e,P.InvalidParameter)}const t=j(e),n={displayName:t.name,objectId:t.oid,tenantId:t.tid,preferredUserName:""};return"2.0"===t.ver?n.preferredUserName=t.preferred_username:"1.0"===t.ver&&(n.preferredUserName=t.upn),n}(this.ssoToken.token)}generateAuthServerError(e){const t=e.errorMessage;if("InteractionRequiredAuthError"===e.name){const e="Failed to get access token from AAD server, interaction required: "+t;return B.warn(e),new M(e,P.UiRequiredError)}if(t&&t.indexOf("AADSTS50013")>=0){const e="Failed to get access token from AAD server, assertion is invalid because of various reasons: "+t;return B.error(e),new M(e,P.TokenExpiredError)}{const e=L(D.FailToAcquireTokenOnBehalfOfUser,t);return B.error(e),new M(e,P.ServiceError)}}}class Q{constructor(e){throw new M(L(D.NodejsRuntimeNotSupported,"TeamsUserCredential"),P.RuntimeNotSupported)}login(e,t){return Promise.reject(new M(L(D.NodejsRuntimeNotSupported,"TeamsUserCredential"),P.RuntimeNotSupported))}getToken(e,t){return Promise.reject(new M(L(D.NodejsRuntimeNotSupported,"TeamsUserCredential"),P.RuntimeNotSupported))}getUserInfo(e){return Promise.reject(new M(L(D.NodejsRuntimeNotSupported,"TeamsUserCredential"),P.RuntimeNotSupported))}}const V="invokeResponse";class W{constructor(e,t){this.id=e,this.failureDetail=t}}class J extends C{constructor(e,t,n,i){super(n),this.initiateLoginEndpoint=t,this.authConfig=e,this.settings=i,$(this.settings.scopes),function(e){if(e.clientId&&(e.clientSecret||e.certificateContent)&&e.tenantId&&e.authorityHost)return;const t=[];e.clientId||t.push("clientId"),e.clientSecret||e.certificateContent||t.push("clientSecret or certificateContent"),e.tenantId||t.push("tenantId"),e.authorityHost||t.push("authorityHost");const n=L(D.InvalidConfiguration,t.join(", "),"undefined");throw B.error(n),new M(n,P.InvalidConfiguration)}(this.authConfig),B.info("Create a new Teams Bot SSO Prompt")}async beginDialog(e){var t;B.info("Begin Teams Bot SSO Prompt"),this.ensureMsTeamsChannel(e);let n=9e5;if(this.settings.timeout){if("number"!=typeof this.settings.timeout){const e="type of timeout property in teamsBotSsoPromptSettings should be number.";throw B.error(e),new M(e,P.InvalidParameter)}if(this.settings.timeout<=0){const e="value of timeout property in teamsBotSsoPromptSettings should be positive.";throw B.error(e),new M(e,P.InvalidParameter)}n=this.settings.timeout}void 0===this.settings.endOnInvalidMessage&&(this.settings.endOnInvalidMessage=!0);const i=null===(t=e.activeDialog)||void 0===t?void 0:t.state;return i.state={},i.options={},i.expires=(new Date).getTime()+n,await this.sendOAuthCardAsync(e.context),C.EndOfTurn}async continueDialog(e){var t;B.info("Continue Teams Bot SSO Prompt"),this.ensureMsTeamsChannel(e);const n=null===(t=e.activeDialog)||void 0===t?void 0:t.state,o=e.context.activity.type===i.Message;if((o||this.isTeamsVerificationInvoke(e.context)||this.isTokenExchangeRequestInvoke(e.context))&&(new Date).getTime()>n.expires)return B.warn("End Teams Bot SSO Prompt due to timeout"),await e.endDialog(void 0);if(this.isTeamsVerificationInvoke(e.context)||this.isTokenExchangeRequestInvoke(e.context)){const t=await this.recognizeToken(e);if(t.succeeded)return await e.endDialog(t.value)}else if(o&&this.settings.endOnInvalidMessage)return B.warn("End Teams Bot SSO Prompt due to invalid message"),await e.endDialog(void 0);return C.EndOfTurn}ensureMsTeamsChannel(e){if(e.context.activity.channelId!=o.Msteams){const e=L(D.OnlyMSTeamsChannelSupported,"Teams Bot SSO Prompt");throw B.error(e),new M(e,P.ChannelNotSupported)}}async sendOAuthCardAsync(e){B.verbose("Send OAuth card to get SSO token");const t=await a.getMember(e,e.activity.from.id);B.verbose("Get Teams member account user principal name: "+(t.userPrincipalName?t.userPrincipalName:""));const n=t.userPrincipalName?t.userPrincipalName:"",i=this.getSignInResource(n),o=r.oauthCard("","Teams SSO Sign In","Sign In",i.signInLink,i.tokenExchangeResource);o.content.buttons[0].type=s.Signin;const d=c.attachment(o);await e.sendActivity(d)}getSignInResource(e){B.verbose("Get sign in authentication configuration");const t=`${this.initiateLoginEndpoint}?scope=${encodeURI(this.settings.scopes.join(" "))}&clientId=${this.authConfig.clientId}&tenantId=${this.authConfig.tenantId}&loginHint=${e}`;B.verbose("Sign in link: "+t);return{signInLink:t,tokenExchangeResource:{id:k()}}}async recognizeToken(e){const t=e.context;let n;if(this.isTokenExchangeRequestInvoke(t))if(B.verbose("Receive token exchange request"),t.activity.value&&this.isTokenExchangeRequest(t.activity.value)){const e=t.activity.value.token,i=new _(e,this.authConfig);let o;try{if(o=await i.getToken(this.settings.scopes),o){await t.sendActivity(this.getTokenExchangeInvokeResponse(d.OK,"",t.activity.value.id));const i=j(e).exp;n={ssoToken:e,ssoTokenExpiration:new Date(1e3*i).toISOString(),connectionName:"",token:o.token,expiration:o.expiresOnTimestamp.toString()}}}catch(e){const n="The bot is unable to exchange token. Ask for user consent.";B.info(n),await t.sendActivity(this.getTokenExchangeInvokeResponse(d.PRECONDITION_FAILED,n,t.activity.value.id))}}else{const e="The bot received an InvokeActivity that is missing a TokenExchangeInvokeRequest value. This is required to be sent with the InvokeActivity.";B.warn(e),await t.sendActivity(this.getTokenExchangeInvokeResponse(d.BAD_REQUEST,e))}else this.isTeamsVerificationInvoke(t)&&(B.verbose("Receive Teams state verification request"),await this.sendOAuthCardAsync(e.context),await t.sendActivity({type:V,value:{status:d.OK}}));return void 0!==n?{succeeded:!0,value:n}:{succeeded:!1}}getTokenExchangeInvokeResponse(e,t,n){return{type:V,value:{status:e,body:new W(n,t)}}}isTeamsVerificationInvoke(e){const t=e.activity;return t.type===i.Invoke&&t.name===l}isTokenExchangeRequestInvoke(e){const t=e.activity;return t.type===i.Invoke&&t.name===u}isTokenExchangeRequest(e){return e.hasOwnProperty("token")}}function Z(e,t){const n=E.create({baseURL:e});return n.interceptors.request.use((async function(e){return await t.AddAuthenticationInfo(e)})),n}class X{constructor(e){this.getToken=e}async AddAuthenticationInfo(e){const t=await this.getToken();if(e.headers||(e.headers={}),e.headers.Authorization)throw new M(D.AuthorizationHeaderAlreadyExists,P.AuthorizationInfoAlreadyExists);return e.headers.Authorization=`Bearer ${t}`,e}}class Y{constructor(e,t){if(!e)throw new M(L(D.EmptyParameter,"username"),P.InvalidParameter);if(!t)throw new M(L(D.EmptyParameter,"password"),P.InvalidParameter);this.userName=e,this.password=t}AddAuthenticationInfo(e){return e.headers&&e.headers.Authorization?Promise.reject(new M(D.AuthorizationHeaderAlreadyExists,P.AuthorizationInfoAlreadyExists)):e.auth?Promise.reject(new M(D.BasicCredentialAlreadyExists,P.AuthorizationInfoAlreadyExists)):(e.auth={username:this.userName,password:this.password},Promise.resolve(e))}}class ee{constructor(e,t,n){if(!e)throw new M(L(D.EmptyParameter,"keyName"),P.InvalidParameter);if(!t)throw new M(L(D.EmptyParameter,"keyVaule"),P.InvalidParameter);this.keyName=e,this.keyValue=t,this.keyLocation=n}AddAuthenticationInfo(e){switch(this.keyLocation){case te.Header:if(e.headers||(e.headers={}),e.headers[this.keyName])return Promise.reject(new M(L(D.DuplicateApiKeyInHeader,this.keyName),P.AuthorizationInfoAlreadyExists));e.headers[this.keyName]=this.keyValue;break;case te.QueryParams:e.params||(e.params={});let t=!1;if(e.url){t=new URL(e.url,e.baseURL).searchParams.has(this.keyName)}if(e.params[this.keyName]||t)return Promise.reject(new M(L(D.DuplicateApiKeyInQueryParam,this.keyName),P.AuthorizationInfoAlreadyExists));e.params[this.keyName]=this.keyValue}return Promise.resolve(e)}}var te,ne,ie,oe;!function(e){e[e.Header=0]="Header",e[e.QueryParams=1]="QueryParams"}(te||(te={}));class ae{constructor(e){if(!e||0===Object.keys(e).length)throw new M(L(D.EmptyParameter,"certOption"),P.InvalidParameter);this.certOption=e}AddAuthenticationInfo(e){if(e.httpsAgent){const t=new Set(Object.keys(e.httpsAgent.options));for(const e of Object.keys(this.certOption))if(t.has(e))return Promise.reject(new M(L(D.DuplicateHttpsOptionProperty,e),P.InvalidParameter));Object.assign(e.httpsAgent.options,this.certOption)}else e.httpsAgent=new x(this.certOption);return Promise.resolve(e)}}function re(e,t,n){if(0===e.length)throw new M(L(D.EmptyParameter,"cert"),P.InvalidParameter);if(0===t.length)throw new M(L(D.EmptyParameter,"key"),P.InvalidParameter);return{cert:e,key:t,passphrase:null==n?void 0:n.passphrase,ca:null==n?void 0:n.ca}}function se(e,t){if(0===e.length)throw new M(L(D.EmptyParameter,"pfx"),P.InvalidParameter);return{pfx:e,passphrase:null==t?void 0:t.passphrase}}!function(e){e.Channel="Channel",e.Group="Group",e.Person="Person"}(ne||(ne={})),function(e){e[e.ReplaceForInteractor=0]="ReplaceForInteractor",e[e.ReplaceForAll=1]="ReplaceForAll",e[e.NewForAll=2]="NewForAll"}(ie||(ie={})),function(e){e[e.BadRequest=400]="BadRequest",e[e.InternalServerError=500]="InternalServerError"}(oe||(oe={}));let ce="BotSsoExecutionDialog",de="TeamsFxSsoPrompt",le="CommandRouteDialog";class ue extends A{constructor(e,t,n,i,o){super(null!=o?o:ce),this.dedupStorageKeys=[],this.commandMapping=new Map,o&&(ce=o,de=o+de,le=o+le);const a=new J(n,i,de,t);this.addDialog(a),this.initialDialogId=le,this.dedupStorage=e,this.dedupStorageKeys=[];const r=new S(le,[this.commandRouteStep.bind(this)]);this.addDialog(r)}addCommand(e,t){const n=this.getCommandHash(t),i=new S(n,[this.ssoStep.bind(this),this.dedupStep.bind(this),async t=>{const n=t.result.tokenResponse,i=t.context,o=t.result.message;try{if(!n)throw new Error(D.FailedToRetrieveSsoToken);return await e(i,n,o),await t.endDialog()}catch(e){const n=L(D.FailedToProcessSsoHandler,e.message);return B.error(n),await t.endDialog(new M(n,P.FailedToProcessSsoHandler))}}]);this.commandMapping.set(n,t),this.addDialog(i)}getCommandHash(e){const t=(Array.isArray(e)?e:[e]).join();return t.replace(/[^a-zA-Z0-9]/g,"")+n("sha256").update(t).digest("hex").toLowerCase()}async run(e,t){const n=new I(t);n.add(this);const i=await n.createContext(e);this.ensureMsTeamsChannel(i);const o=await i.continueDialog();if(o&&o.status===T.empty)await i.beginDialog(this.id);else if(o&&o.status===T.complete&&o.result instanceof Error)throw o.result}getActivityText(e){let t=e.text;const n=h.removeRecipientMention(e);return n&&(t=n.toLowerCase().replace(/\n|\r\n/g,"").trim()),t}async commandRouteStep(e){const t=e.context,n=this.getActivityText(t.activity),i=this.getMatchesCommandId(n);if(i)return await e.beginDialog(i);const o=L(D.CannotFindCommand,t.activity.text);throw B.error(o),new M(o,P.CannotFindCommand)}async ssoStep(e){try{const t=e.context,n={text:this.getActivityText(t.activity)};return e.options.commandMessage=n,await e.beginDialog(de)}catch(t){const n=L(D.FailedToRunSsoStep,t.message);return B.error(n),await e.endDialog(new M(n,P.FailedToRunSsoStep))}}async dedupStep(e){const t=e.result;if(!t)return B.error(D.FailedToRetrieveSsoToken),await e.endDialog(new M(D.FailedToRetrieveSsoToken,P.FailedToRunSsoStep));try{return t&&await this.shouldDedup(e.context)?C.EndOfTurn:await e.next({tokenResponse:t,message:e.options.commandMessage})}catch(t){const n=L(D.FailedToRunDedupStep,t.message);return B.error(n),await e.endDialog(new M(n,P.FailedToRunDedupStep))}}async onEndDialog(e){const t=e.activity.conversation.id,n=this.dedupStorageKeys.filter((e=>e.indexOf(t)>0));await this.dedupStorage.delete(n),this.dedupStorageKeys=this.dedupStorageKeys.filter((e=>e.indexOf(t)<0))}async shouldDedup(e){const t={eTag:e.activity.value.id},n=this.getStorageKey(e),i={[n]:t};try{await this.dedupStorage.write(i),this.dedupStorageKeys.push(n)}catch(e){if(e instanceof Error&&e.message.indexOf("eTag conflict"))return!0;throw e}return!1}getStorageKey(e){if(!e||!e.activity||!e.activity.conversation)throw new Error("Invalid context, can not get storage key!");const t=e.activity,n=t.channelId,o=t.conversation.id;if(t.type!==i.Invoke||t.name!==u)throw new Error("TokenExchangeState can only be used with Invokes of signin/tokenExchange.");const a=t.value;if(!a||!a.id)throw new Error("Invalid signin/tokenExchange. Missing activity.value.id.");return`${n}/${o}/${a.id}`}matchPattern(e,t){if(t){if("string"==typeof e){return new RegExp(e,"i").test(t)}if(e instanceof RegExp){const n=t.match(e);return null!=n&&n}}return!1}isPatternMatched(e,t){const n=Array.isArray(e)?e:[e];for(const e of n){return!!this.matchPattern(e,t)}return!1}getMatchesCommandId(e){for(const t of this.commandMapping){const n=t[1];if(this.isPatternMatched(n,e))return t[0]}}ensureMsTeamsChannel(e){if(e.context.activity.channelId!=o.Msteams){const e=L(D.OnlyMSTeamsChannelSupported,"SSO execution dialog");throw B.error(e),new M(e,P.ChannelNotSupported)}}}class he{static attachAdaptiveCard(e,t){const n={$root:t};return{attachments:[r.adaptiveCard(new R.Template(e).expand(n))]}}static attachAdaptiveCardWithoutData(e){return{attachments:[r.adaptiveCard(e)]}}static attachHeroCard(e,t,n,i){return he.attachContent(r.heroCard(e,t,n,i))}static attachSigninCard(e,t,n){return he.attachContent(r.signinCard(e,t,n))}static attachO365ConnectorCard(e){return he.attachContent(r.o365ConnectorCard(e))}static AttachReceiptCard(e){return he.attachContent(r.receiptCard(e))}static attachThumbnailCard(e,t,n,i){return he.attachContent(r.thumbnailCard(e,t,n,i))}static attachContent(e){return{attachments:[e]}}}var pe,ve,me;!function(e){e.AdaptiveCard="application/vnd.microsoft.card.adaptive",e.Message="application/vnd.microsoft.activity.message",e.Error="application/vnd.microsoft.error"}(pe||(pe={}));class fe{static textMessage(e){if(!e)throw new Error("The text message cannot be null or empty");return{status:d.OK,body:{statusCode:d.OK,type:pe.Message,value:e}}}static adaptiveCard(e){if(!e)throw new Error("The adaptive card content cannot be null or undefined");return{status:d.OK,body:{statusCode:d.OK,type:pe.AdaptiveCard,value:e}}}static errorResponse(e,t){return{status:d.OK,body:{statusCode:e,type:pe.Error,value:{code:e.toString(),message:t}}}}static createInvokeResponse(e,t){return{status:e,body:t}}}async function ye(e,t,n,o,a){const r=e.activity.value;if(!r.authentication||!r.authentication.token)return B.verbose("No AccessToken in request, return silentAuth for AccessToken"),function(e,t,n){const i=z(n);return{composeExtension:{type:"silentAuth",suggestedActions:{actions:[{type:"openUrl",value:`${t}?scope=${encodeURI(i.join(" "))}&clientId=${e.clientId}&tenantId=${e.tenantId}`,title:"Message Extension OAuth"}]}}}}(t,n,o);try{const e=new _(r.authentication.token,t),n=await e.getToken(o),i=j(r.authentication.token).exp,s={ssoToken:r.authentication.token,ssoTokenExpiration:new Date(1e3*i).toISOString(),token:n.token,expiration:n.expiresOnTimestamp.toString(),connectionName:""};if(a)return await a(s)}catch(a){if(a instanceof M&&a.code===P.UiRequiredError&&"composeExtension/query"===e.activity.name){B.verbose("User not consent yet, return 412 to user consent first.");const t={status:412};return void await e.sendActivity({value:t,type:i.InvokeResponse})}if(a instanceof M&&a.code===P.UiRequiredError&&"composeExtension/queryLink"===e.activity.name){B.verbose("User not consent yet, return auth card for user login");const a=function(e,t,n){const i=z(n);return{composeExtension:{type:"auth",suggestedActions:{actions:[{type:"openUrl",value:`${t}?scope=${encodeURI(i.join(" "))}&clientId=${e.clientId}&tenantId=${e.tenantId}`,title:"Message Extension OAuth"}]}}}}(t,n,o);return void await e.sendActivity({value:{status:200,body:a},type:i.InvokeResponse})}throw a}}async function ge(e,t,n,i,o){if("composeExtension/query"!=e.activity.name)throw B.error(D.OnlySupportInQueryActivity),new M(L(D.OnlySupportInQueryActivity),P.FailedOperation);return await ye(e,null!=t?t:{},n,i,o)}async function we(e,t,n,i,o){if("composeExtension/queryLink"!=e.activity.name)throw B.error(D.OnlySupportInLinkQueryActivity),new M(L(D.OnlySupportInLinkQueryActivity),P.FailedOperation);return await ye(e,null!=t?t:{},n,i,o)}class Ce{constructor(e){this.actionHandlers=[],this.defaultMessage="Your response was sent to the app",e&&e.length>0&&this.actionHandlers.push(...e)}async onTurn(e,t){var n,i,o;if("adaptiveCard/action"===e.activity.name){const t=e.activity.value.action,a=t.verb;for(const s of this.actionHandlers)if((null===(n=s.triggerVerb)||void 0===n?void 0:n.toLowerCase())===(null==a?void 0:a.toLowerCase())){let n;try{n=await s.handleActionInvoked(e,t.data)}catch(t){const n=fe.errorResponse(oe.InternalServerError,t.message);throw await this.sendInvokeResponse(e,n),t}switch(null===(i=n.body)||void 0===i?void 0:i.type){case pe.AdaptiveCard:const t=null===(o=n.body)||void 0===o?void 0:o.value;if(!t){const t="Adaptive card content cannot be found in the response body";throw await this.sendInvokeResponse(e,fe.errorResponse(oe.InternalServerError,t)),new Error(t)}t.refresh&&s.adaptiveCardResponse!==ie.NewForAll&&(s.adaptiveCardResponse=ie.ReplaceForAll);const i=c.attachment(r.adaptiveCard(t));s.adaptiveCardResponse===ie.NewForAll?(await this.sendInvokeResponse(e,fe.textMessage(this.defaultMessage)),await e.sendActivity(i)):s.adaptiveCardResponse===ie.ReplaceForAll?(i.id=e.activity.replyToId,await e.updateActivity(i),await this.sendInvokeResponse(e,n)):await this.sendInvokeResponse(e,n);break;case pe.Message:case pe.Error:default:await this.sendInvokeResponse(e,n)}break}}await t()}async sendInvokeResponse(e,t){await e.sendActivity({type:i.InvokeResponse,value:t})}}class Ae{constructor(e,t){this.middleware=new Ce(null==t?void 0:t.actions),this.adapter=e.use(this.middleware)}registerHandler(e){e&&this.middleware.actionHandlers.push(e)}registerHandlers(e){e&&this.middleware.actionHandlers.push(...e)}}class Se{constructor(e,t,n){if(this.commandHandlers=[],this.ssoCommandHandlers=[],e=null!=e?e:[],t=null!=t?t:[],this.hasSsoCommand=t.length>0,this.ssoActivityHandler=n,this.hasSsoCommand&&!this.ssoActivityHandler)throw B.error(D.SsoActivityHandlerIsNull),new M(D.SsoActivityHandlerIsNull,P.SsoActivityHandlerIsUndefined);this.commandHandlers.push(...e);for(const e of t)this.addSsoCommand(e)}addSsoCommand(e){var t;null===(t=this.ssoActivityHandler)||void 0===t||t.addCommand((async(t,n,i)=>{const o=this.shouldTrigger(e.triggerPatterns,i.text);i.matches=Array.isArray(o)?o:void 0;const a=await e.handleCommandReceived(t,i,n);await this.processResponse(t,a)}),e.triggerPatterns),this.ssoCommandHandlers.push(e),this.hasSsoCommand=!0}async onTurn(e,t){var n,o;if(e.activity.type===i.Message){const t=this.getActivityText(e.activity);let i=!1;for(const n of this.commandHandlers){const o=this.shouldTrigger(n.triggerPatterns,t);if(o){const a={text:t};a.matches=Array.isArray(o)?o:void 0;const r=await n.handleCommandReceived(e,a);await this.processResponse(e,r),i=!0;break}}if(!i)for(const i of this.ssoCommandHandlers){if(this.shouldTrigger(i.triggerPatterns,t)){await(null===(n=this.ssoActivityHandler)||void 0===n?void 0:n.run(e));break}}}else this.hasSsoCommand&&await(null===(o=this.ssoActivityHandler)||void 0===o?void 0:o.run(e));await t()}async processResponse(e,t){if("string"==typeof t)await e.sendActivity(t);else{const n=t;n&&await e.sendActivity(n)}}matchPattern(e,t){if(t){if("string"==typeof e){return new RegExp(e,"i").test(t)}if(e instanceof RegExp){const n=t.match(e);return null!=n&&n}}return!1}shouldTrigger(e,t){const n=Array.isArray(e)?e:[e];for(const e of n){const n=this.matchPattern(e,t);if(n)return n}return!1}getActivityText(e){let t=e.text;const n=h.removeRecipientMention(e);return n&&(t=n.toLowerCase().replace(/\n|\r\n/g,"").trim()),t}}class Ie{constructor(e,t,n,i){this.ssoConfig=i,this.middleware=new Se(null==t?void 0:t.commands,null==t?void 0:t.ssoCommands,n),this.adapter=e.use(this.middleware)}registerCommand(e){e&&this.middleware.commandHandlers.push(e)}registerCommands(e){e&&this.middleware.commandHandlers.push(...e)}registerSsoCommand(e){this.validateSsoActivityHandler(),this.middleware.addSsoCommand(e)}registerSsoCommands(e){if(e.length>0){this.validateSsoActivityHandler();for(const t of e)this.middleware.addSsoCommand(t)}}validateSsoActivityHandler(){if(!this.middleware.ssoActivityHandler)throw B.error(D.SsoActivityHandlerIsNull),new M(D.SsoActivityHandlerIsNull,P.SsoActivityHandlerIsUndefined)}}function Te(e){return JSON.parse(JSON.stringify(e))}function ke(e){var t,n;return`_${null===(t=e.conversation)||void 0===t?void 0:t.tenantId}_${null===(n=e.conversation)||void 0===n?void 0:n.id}`}function Ee(e){var t,n,i;const o=null===(i=null===(n=null===(t=e.activity)||void 0===t?void 0:t.channelData)||void 0===n?void 0:n.team)||void 0===i?void 0:i.id;return o||(void 0===e.activity.conversation.name?e.activity.conversation.id:void 0)}!function(e){e[e.CurrentBotInstalled=0]="CurrentBotInstalled",e[e.CurrentBotMessaged=1]="CurrentBotMessaged",e[e.CurrentBotUninstalled=2]="CurrentBotUninstalled",e[e.TeamDeleted=3]="TeamDeleted",e[e.TeamRestored=4]="TeamRestored",e[e.Unknown=5]="Unknown"}(ve||(ve={}));class xe{constructor(e){this.conversationReferenceStore=e.conversationReferenceStore}async onTurn(e,t){switch(this.classifyActivity(e.activity)){case ve.CurrentBotInstalled:case ve.TeamRestored:{const t=h.getConversationReference(e.activity);await this.conversationReferenceStore.add(ke(t),t,{overwrite:!0});break}case ve.CurrentBotMessaged:await this.tryAddMessagedReference(e);break;case ve.CurrentBotUninstalled:case ve.TeamDeleted:{const t=h.getConversationReference(e.activity);await this.conversationReferenceStore.remove(ke(t),t);break}}await t()}classifyActivity(e){var t,n;const i=e.type;if("installationUpdate"===i){const n=null===(t=e.action)||void 0===t?void 0:t.toLowerCase();return"add"===n||"add-upgrade"===n?ve.CurrentBotInstalled:ve.CurrentBotUninstalled}if("conversationUpdate"===i){const t=null===(n=e.channelData)||void 0===n?void 0:n.eventType;if("teamDeleted"===t)return ve.TeamDeleted;if("teamRestored"===t)return ve.TeamRestored}else if("message"===i)return ve.CurrentBotMessaged;return ve.Unknown}async tryAddMessagedReference(e){var t,n,i,o,a,r;const s=h.getConversationReference(e.activity),c=null===(t=null==s?void 0:s.conversation)||void 0===t?void 0:t.conversationType;if("personal"===c||"groupChat"===c)await this.conversationReferenceStore.add(ke(s),s,{overwrite:!1});else if("channel"===c){const t=null===(o=null===(i=null===(n=e.activity)||void 0===n?void 0:n.channelData)||void 0===i?void 0:i.team)||void 0===o?void 0:o.id,c=null===(r=null===(a=e.activity.channelData)||void 0===a?void 0:a.channel)||void 0===r?void 0:r.id;if(void 0!==t&&(void 0===c||t===c)){const e=Te(s);e.conversation.id=t,await this.conversationReferenceStore.add(ke(e),e,{overwrite:!1})}}}}class Re{constructor(e){var t;this.localFileName=null!==(t=process.env.TEAMSFX_NOTIFICATION_STORE_FILENAME)&&void 0!==t?t:".notification.localstore.json",this.filePath=b.resolve(e,this.localFileName)}async add(e,t,n){if(n.overwrite||!await this.storeFileExists()){if(await this.storeFileExists()){const n=await this.readFromFile();await this.writeToFile(Object.assign(n,{[e]:t}))}else await this.writeToFile({[e]:t});return!0}return!1}async remove(e,t){if(!await this.storeFileExists())return!1;if(await this.storeFileExists()){const t=await this.readFromFile();void 0!==t[e]&&(delete t[e],await this.writeToFile(t))}return!0}async list(e,t){if(!await this.storeFileExists())return{data:[],continuationToken:""};const n=await this.readFromFile();return{data:Object.entries(n).map((e=>e[1])),continuationToken:""}}storeFileExists(){return new Promise((e=>{try{O.access(this.filePath,(t=>{e(!t)}))}catch(t){e(!1)}}))}readFromFile(){return new Promise(((e,t)=>{try{O.readFile(this.filePath,{encoding:"utf-8"},((n,i)=>{n?t(n):e(JSON.parse(i))}))}catch(e){t(e)}}))}async writeToFile(e){return new Promise(((t,n)=>{try{const i=JSON.stringify(e,void 0,2);O.writeFile(this.filePath,i,{encoding:"utf-8"},(e=>{e?n(e):t()}))}catch(e){n(e)}}))}}class be{constructor(e,t){this.type=ne.Channel,this.parent=e,this.info=t}async sendMessage(e,t){const n={};return await this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(async i=>{const o=await this.newConversation(i);await this.parent.adapter.continueConversationAsync(this.parent.botAppId,o,(async i=>{try{const t=await i.sendActivity(e);n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}}))})),n}async sendAdaptiveCard(e,t){const n={};return await this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(async i=>{const o=await this.newConversation(i);await this.parent.adapter.continueConversationAsync(this.parent.botAppId,o,(async i=>{try{const t=await i.sendActivity({attachments:[r.adaptiveCard(e)]});n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}}))})),n}newConversation(e){const t=Te(h.getConversationReference(e.activity));return t.conversation.id=this.info.id||"",Promise.resolve(t)}}class Oe{constructor(e,t){this.type=ne.Person,this.parent=e,this.account=t}async sendMessage(e,t){const n={};return await this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(async i=>{const o=await this.newConversation(i);await this.parent.adapter.continueConversationAsync(this.parent.botAppId,o,(async i=>{try{const t=await i.sendActivity(e);n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}}))})),n}async sendAdaptiveCard(e,t){const n={};return await this.parent.adapter.continueConversationAsync(this.parent.botAppId,this.parent.conversationReference,(async i=>{const o=await this.newConversation(i);await this.parent.adapter.continueConversationAsync(this.parent.botAppId,o,(async i=>{try{const t=await i.sendActivity({attachments:[r.adaptiveCard(e)]});n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}}))})),n}async newConversation(e){const t=Te(h.getConversationReference(e.activity)),n=e.turnState.get(this.parent.adapter.ConnectorClientKey),i=await n.conversations.createConversation({isGroup:!1,tenantId:e.activity.conversation.tenantId,bot:e.activity.recipient,members:[this.account],channelData:{}});return t.conversation.id=i.id,t}}class Pe{constructor(e,t,n){this.adapter=e,this.conversationReference=t,this.type=function(e){var t;const n=null===(t=e.conversation)||void 0===t?void 0:t.conversationType;return"personal"===n?ne.Person:"groupChat"===n?ne.Group:"channel"===n?ne.Channel:void 0}(t),this.botAppId=n}async sendMessage(e,t){const n={};return await this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(async i=>{try{const t=await i.sendActivity(e);n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}})),n}async sendAdaptiveCard(e,t){const n={};return await this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(async i=>{try{const t=await i.sendActivity({attachments:[r.adaptiveCard(e)]});n.id=null==t?void 0:t.id}catch(e){if(!t)throw e;await t(i,e)}})),n}async channels(){const e=[];if(this.type!==ne.Channel)return e;let t=[];await this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(async e=>{const n=Ee(e);void 0!==n&&(t=await a.getTeamChannels(e,n))}));for(const n of t)e.push(new be(this,n));return e}async getPagedMembers(e,t){let n={data:[],continuationToken:""};return await this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(async i=>{const o=await a.getPagedMembers(i,e,t);n={data:o.members.map((e=>new Oe(this,e))),continuationToken:o.continuationToken}})),n}async getTeamDetails(){if(this.type!==ne.Channel)return;let e;return await this.adapter.continueConversationAsync(this.botAppId,this.conversationReference,(async t=>{const n=Ee(t);void 0!==n&&(e=await a.getTeamDetails(t,n))})),e}}class Fe{constructor(e,t){var n,i;(null==t?void 0:t.store)?this.conversationReferenceStore=t.store:this.conversationReferenceStore=new Re(b.resolve("1"===process.env.RUNNING_ON_AZURE&&null!==(n=process.env.TEMP)&&void 0!==n?n:"./")),this.adapter=e.use(new xe({conversationReferenceStore:this.conversationReferenceStore})),this.botAppId=null!==(i=null==t?void 0:t.botAppId)&&void 0!==i?i:process.env.BOT_ID}buildTeamsBotInstallation(e){if(!e)throw new Error("conversationReference is required.");return new Pe(this.adapter,e,this.botAppId)}async validateInstallation(e){let t=!0;return await this.adapter.continueConversationAsync(this.botAppId,e,(async e=>{try{await a.getPagedMembers(e,1)}catch(e){"BotNotInConversationRoster"===e.code&&(t=!1)}})),t}async getPagedInstallations(e,t,n=!0){if(void 0===this.conversationReferenceStore||void 0===this.adapter)throw new Error("NotificationBot has not been initialized.");const i=await this.conversationReferenceStore.list(e,t),o=[];for(const e of i.data){let t;n&&(t=await this.validateInstallation(e)),!n||n&&t?o.push(new Pe(this.adapter,e,this.botAppId)):await this.conversationReferenceStore.remove(ke(e),e)}return{data:o,continuationToken:i.continuationToken}}async findMember(e,t){for(const n of await this.installations())if(this.matchSearchScope(n,t)){const t=[];let i;do{const e=await n.getPagedMembers(void 0,i);i=e.continuationToken,t.push(...e.data)}while(i);for(const n of t)if(await e(n))return n}}async findChannel(e){for(const t of await this.installations())if(t.type===ne.Channel){const n=await t.getTeamDetails();for(const i of await t.channels())if(await e(i,n))return i}}async findAllMembers(e,t){const n=[];for(const i of await this.installations())if(this.matchSearchScope(i,t)){const t=[];let o;do{const e=await i.getPagedMembers(void 0,o);o=e.continuationToken,t.push(...e.data)}while(o);for(const i of t)await e(i)&&n.push(i)}return n}async findAllChannels(e){const t=[];for(const n of await this.installations())if(n.type===ne.Channel){const i=await n.getTeamDetails();for(const o of await n.channels())await e(o,i)&&t.push(o)}return t}matchSearchScope(e,t){return t=null!=t?t:me.All,e.type===ne.Channel&&0!=(t&me.Channel)||e.type===ne.Group&&0!=(t&me.Group)||e.type===ne.Person&&0!=(t&me.Person)}async installations(){let e;const t=[];do{const n=await this.getPagedInstallations(void 0,e);e=n.continuationToken,t.push(...n.data)}while(e);return t}}!function(e){e[e.Person=1]="Person",e[e.Group=2]="Group",e[e.Channel=4]="Channel",e[e.All=7]="All"}(me||(me={}));class De extends p{constructor(e){var t,n,i,o,a,r,s,c,d,l;super();const u=new v,h=null!==(n=null===(t=e.dialog)||void 0===t?void 0:t.userState)&&void 0!==n?n:new m(u),p=null!==(o=null===(i=e.dialog)||void 0===i?void 0:i.conversationState)&&void 0!==o?o:new f(u),y=null!==(r=null===(a=e.dialog)||void 0===a?void 0:a.dedupStorage)&&void 0!==r?r:u,g=e.aad,{scopes:w}=g,C=
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(n[i[o]]=e[i[o]])}return n}(g,["scopes"]),A={scopes:w,timeout:null===(c=null===(s=e.dialog)||void 0===s?void 0:s.ssoPromptConfig)||void 0===c?void 0:c.timeout,endOnInvalidMessage:null===(l=null===(d=e.dialog)||void 0===d?void 0:d.ssoPromptConfig)||void 0===l?void 0:l.endOnInvalidMessage};this.ssoExecutionDialog=new ue(y,A,C,C.initiateLoginEndpoint),this.conversationState=p,this.dialogState=p.createProperty("DialogState"),this.userState=h,this.onMessage((async(e,t)=>{await this.ssoExecutionDialog.run(e,this.dialogState),await t()}))}addCommand(e,t){this.ssoExecutionDialog.addCommand(e,t)}async run(e){try{await super.run(e)}finally{await this.conversationState.saveChanges(e,!1),await this.userState.saveChanges(e,!1)}}async handleTeamsSigninVerifyState(e,t){await this.ssoExecutionDialog.run(e,this.dialogState)}async handleTeamsSigninTokenExchange(e,t){await this.ssoExecutionDialog.run(e,this.dialogState)}}var Me=Object.freeze({__proto__:null,BotSsoExecutionDialog:ue,CardActionBot:Ae,Channel:be,CommandBot:Ie,ConversationBot:class{constructor(e){var t,n,i,o;let a;e.adapter?this.adapter=e.adapter:this.adapter=this.createDefaultAdapter(e.adapterConfig),(null==e?void 0:e.ssoConfig)&&(a=(null===(t=e.ssoConfig.dialog)||void 0===t?void 0:t.CustomBotSsoExecutionActivityHandler)?new e.ssoConfig.dialog.CustomBotSsoExecutionActivityHandler(e.ssoConfig):new De(e.ssoConfig)),(null===(n=e.command)||void 0===n?void 0:n.enabled)&&(this.command=new Ie(this.adapter,e.command,a,e.ssoConfig)),(null===(i=e.notification)||void 0===i?void 0:i.enabled)&&(this.notification=new Fe(this.adapter,e.notification)),(null===(o=e.cardAction)||void 0===o?void 0:o.enabled)&&(this.cardAction=new Ae(this.adapter,e.cardAction))}createDefaultAdapter(e){const t=new y(void 0===e?{MicrosoftAppId:process.env.BOT_ID,MicrosoftAppPassword:process.env.BOT_PASSWORD,MicrosoftAppType:"MultiTenant"}:e),n=new g({},t),i=new w(n);return i.onTurnError=async(e,t)=>{console.error("[onTurnError] unhandled error",t),"message"===e.activity.type&&(await e.sendTraceActivity("OnTurnError Trace",t instanceof Error?t.message:t,"https://www.botframework.com/schemas/error","TurnError"),await e.sendActivity(`The bot encountered unhandled error: ${t.message}`),await e.sendActivity("To continue to run this bot, please fix the bot source code."))},i}async requestHandler(e,t,n){void 0===n&&(n=async()=>{}),await this.adapter.process(e,t,n)}},Member:Oe,NotificationBot:Fe,get SearchScope(){return me},TeamsBotInstallation:Pe,sendAdaptiveCard:function(e,t,n){return e.sendAdaptiveCard(t,n)},sendMessage:function(e,t,n){return e.sendMessage(t,n)}});export{ie as AdaptiveCardResponse,te as ApiKeyLocation,ee as ApiKeyProvider,G as AppCredential,Y as BasicAuthProvider,X as BearerTokenAuthProvider,Me as BotBuilderCloudAdapter,ue as BotSsoExecutionDialog,ae as CertificateAuthProvider,P as ErrorCode,M as ErrorWithCode,oe as InvokeResponseErrorCode,fe as InvokeResponseFactory,F as LogLevel,he as MessageBuilder,ne as NotificationTargetType,_ as OnBehalfOfUserCredential,J as TeamsBotSsoPrompt,Q as TeamsUserCredential,Z as createApiClient,re as createPemCertOption,se as createPfxCertOption,H as getLogLevel,we as handleMessageExtensionLinkQueryWithSSO,ge as handleMessageExtensionQueryWithSSO,q as setLogFunction,N as setLogLevel,U as setLogger};
//# sourceMappingURL=index.esm2017.mjs.map
